<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <script>
        // --- PERBAIKAN LOGIKA PROTEKSI HALAMAN (v2) ---
        // Definisikan variabel sesi di scope global (window) agar bisa diakses di mana saja.
        window.loggedInAdminName = sessionStorage.getItem('loggedInAdminName') || 'Admin';
        window.loggedInKoperasi = sessionStorage.getItem('loggedInKoperasi');
        const adminToken = sessionStorage.getItem('admin_token');

        // Sesi dianggap tidak valid jika token atau nama koperasi tidak ada.
        if (!adminToken || !window.loggedInKoperasi) {
            // Alihkan ke halaman login tanpa alert.
            // Ini adalah alur yang benar jika halaman dasbor diakses langsung.
            window.location.replace('admin_apk_login.html');
        }
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Back Marketplace</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for reports -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" href="assets/logogpid.png" type="image/png">
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- FullCalendar for scheduling -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>

    <style></style>
</head>
<body class="bg-slate-100 text-slate-800">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-slate-800 text-white flex flex-col flex-shrink-0 p-4 transition-all duration-300 ease-in-out -translate-x-full md:translate-x-0 md:relative z-20">
            <div class="flex items-center mb-8 flex-shrink-0" style="perspective: 800px;">
                <img src="assets/logogpid.png" alt="Logo Gerbang Pangan" class="h-12 w-12 mr-3 object-contain animate-spin-horizontal">
                <div>
                    <h1 id="sidebar-koperasi-name" class="text-xl font-bold">Nama Koperasi</h1>
                    <p id="sidebar-admin-name" class="text-xs text-slate-400">oleh Admin</p>
                </div>
            </div>
            <nav id="sidebar-nav" class="space-y-2 overflow-y-auto">
                <a href="#" data-target="page-dasbor" class="sidebar-link flex items-center py-2.5 px-4 rounded-lg transition duration-200 hover:bg-slate-700 sidebar-link-active">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>
                    Dasbor
                </a>
                <a href="#" data-target="page-pelanggan" class="sidebar-link flex items-center py-2.5 px-4 rounded-lg transition duration-200 hover:bg-slate-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                    Manajemen User APK
                </a>

                <p class="px-4 pt-4 pb-2 text-xs font-semibold text-slate-400 uppercase">Marketplace</p>
                <a href="#" data-target="page-produk" class="sidebar-link flex items-center py-2.5 px-4 rounded-lg transition duration-200 hover:bg-slate-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
                    Produk
                </a>
                <a href="#" data-target="page-stok-gudang" class="sidebar-link flex items-center py-2.5 px-4 rounded-lg transition duration-200 hover:bg-slate-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                    Stok Gudang
                </a>
                <a href="#" data-target="page-pesanan" class="sidebar-link flex justify-between items-center py-2.5 px-4 rounded-lg transition duration-200 hover:bg-slate-700">
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" /></svg>
                        <span>Pesanan</span>
                    </div>
                    <span id="badge-pesanan" class="bg-rose-500 text-white text-xs font-bold px-2 py-0.5 rounded-full hidden"></span>
                </a>
                <a href="#" data-target="page-ulasan" class="sidebar-link flex justify-between items-center py-2.5 px-4 rounded-lg transition duration-200 hover:bg-slate-700">
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.083-3.083A7.002 7.002 0 012 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM4.417 14.417A6 6 0 0010 16c3.309 0 6-2.691 6-6s-2.691-6-6-6-6 2.691-6 6c0 1.282.393 2.472 1.056 3.488L4.417 14.417z" clip-rule="evenodd" /></svg>
                        <span>Ulasan</span>
                    </div>
                    <span id="badge-ulasan" class="bg-amber-500 text-white text-xs font-bold px-2 py-0.5 rounded-full hidden"></span>
                </a>
                <a href="#" data-target="page-permintaan" class="sidebar-link flex justify-between items-center py-2.5 px-4 rounded-lg transition duration-200 hover:bg-slate-700">
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <span>Pesan Permintaan</span>
                    </div>
                    <span id="badge-permintaan" class="bg-sky-500 text-white text-xs font-bold px-2 py-0.5 rounded-full hidden"></span>
                </a>
                <a href="#" data-target="page-kategori" class="sidebar-link flex items-center py-2.5 px-4 rounded-lg transition duration-200 hover:bg-slate-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M2 5a2 2 0 012-2h4a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2V5zM12 5a2 2 0 012-2h4a2 2 0 012 2v4a2 2 0 01-2 2h-4a2 2 0 01-2-2V5zM2 13a2 2 0 012-2h4a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4zM15 13a1 1 0 011-1h2a1 1 0 110 2h-2a1 1 0 01-1-1zm-1 3a1 1 0 100 2h2a1 1 0 100-2h-2z" /></svg>
                    Kategori
                </a>
                <a href="#" data-target="page-notifikasi" class="sidebar-link flex items-center py-2.5 px-4 rounded-lg transition duration-200 hover:bg-slate-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                    Notifikasi
                </a>

                <p class="px-4 pt-4 pb-2 text-xs font-semibold text-slate-400 uppercase">Petani</p>
                <a href="#" data-target="page-jadwal-tanam" class="sidebar-link flex items-center py-2.5 px-4 rounded-lg transition duration-200 hover:bg-slate-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    Jadwal Tanam
                </a>
                <a href="#" data-target="page-jadwal-panen" class="sidebar-link flex items-center py-2.5 px-4 rounded-lg transition duration-200 hover:bg-slate-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    Jadwal Panen
                </a>
                <a href="#" data-target="page-luas-lahan" class="sidebar-link flex items-center py-2.5 px-4 rounded-lg transition duration-200 hover:bg-slate-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2h1a2 2 0 002-2v-1a2 2 0 012-2H19.95M12 11v-1a2 2 0 00-2-2H9a2 2 0 00-2 2v1" /></svg>
                    Luas Lahan
                </a>
                
                <a href="#" data-target="page-info-penawaran" class="sidebar-link flex justify-between items-center py-2.5 px-4 rounded-lg transition duration-200 hover:bg-slate-700">
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" /></svg>
                        <span>Info Penawaran</span>
                    </div>
                    <span id="badge-penawaran" class="bg-sky-500 text-white text-xs font-bold px-2 py-0.5 rounded-full hidden"></span>
                </a>
                <a href="#" data-target="page-kebutuhan-stok" class="sidebar-link flex items-center py-2.5 px-4 rounded-lg transition duration-200 hover:bg-slate-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7l8 5 8-5" /></svg>
                    Kebutuhan Stok
                </a>

                <p class="px-4 pt-4 pb-2 text-xs font-semibold text-slate-400 uppercase">Koperasi</p>
                <a href="#" data-target="page-simpanan" class="sidebar-link flex items-center py-2.5 px-4 rounded-lg transition duration-200 hover:bg-slate-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M8.433 7.418c.158-.103.346-.196.567-.267v1.698a2.5 2.5 0 004 0V7.151c.22.07.409.164.567.267C13.882 7.64 14 7.969 14 8.5v3a1 1 0 11-2 0v-1.118a1 1 0 00-1-1h-2a1 1 0 00-1 1V11.5a1 1 0 11-2 0v-3c0-.53.118-.86.433-1.082zM12 3c2.76 0 5 2.24 5 5s-2.24 5-5 5-5-2.24-5-5 2.24-5 5-5zM4 18a4 4 0 014-4h4a4 4 0 014 4v.5a.5.5 0 01-.5.5h-11a.5.5 0 01-.5-.5V18z" /></svg>
                    Simpanan
                </a>
                <a href="#" data-target="page-pinjaman" class="sidebar-link flex items-center py-2.5 px-4 rounded-lg transition duration-200 hover:bg-slate-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                    Pinjaman
                </a>

                <p class="px-4 pt-4 pb-2 text-xs font-semibold text-slate-400 uppercase">Integrasi Eksternal</p>
                <a href="#" data-target="page-perumda" class="sidebar-link flex items-center py-2.5 px-4 rounded-lg transition duration-200 hover:bg-slate-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h6m-6 4h6m-6 4h6" />
                    </svg>
                    Perumda
                </a>

                <p class="px-4 pt-4 pb-2 text-xs font-semibold text-slate-400 uppercase">Sistem</p>
                <a href="#" data-target="page-laporan" class="sidebar-link flex items-center py-2.5 px-4 rounded-lg transition duration-200 hover:bg-slate-700">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                    Laporan
                </a>
                <a href="#" data-target="page-pembelian" class="sidebar-link flex items-center py-2.5 px-4 rounded-lg transition duration-200 hover:bg-slate-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>
                    Riwayat Pembelian
                </a>
                <a href="#" data-target="page-metode-pembayaran" class="sidebar-link flex items-center py-2.5 px-4 rounded-lg transition duration-200 hover:bg-slate-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H4a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg>
                    Metode Pembayaran
                </a>

            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto">
            <!-- Header -->
            <header class="bg-white shadow-sm p-4 flex justify-between items-center sticky top-0 z-10">
                <div class="flex items-center">
                    <button id="menu-btn" class="text-slate-500 hover:text-slate-700 md:hidden mr-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                    </button>
                    <h2 id="header-title" class="text-2xl font-semibold text-slate-700 hidden sm:block">Dasbor</h2>
                </div>
                <div class="flex items-center space-x-2 sm:space-x-4">

                    <!-- Notifications Dropdown -->
                    <div class="relative">
                        <button id="notif-btn" class="p-2 bg-slate-100 rounded-full hover:bg-slate-200 text-slate-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                        </button>
                        <div id="notif-dropdown" class="dropdown-menu absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-xl overflow-hidden hidden opacity-0 scale-95">
                           <div class="p-4 font-semibold border-b">Notifikasi</div>
                           <div class="divide-y">
                               <a href="#" class="block p-4 hover:bg-slate-50"><p class="font-medium">Pesanan baru #ORD-1238</p><p class="text-sm text-slate-500">2 menit yang lalu</p></a>
                           </div>
                        </div>
                    </div>
                    <!-- Profile Dropdown -->
                    <div class="relative">
                         <button id="profile-btn">
                             <img id="profile-avatar" src="https://placehold.co/40x40/E2E8F0/475569?text=A" alt="Avatar" class="w-10 h-10 rounded-full">
                         </button>
                         <div id="profile-dropdown" class="dropdown-menu absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl overflow-hidden hidden opacity-0 scale-95">
                               <a href="#" id="admin-profile-btn" class="block px-4 py-2 text-slate-700 hover:bg-slate-100">Profil Admin</a>
                               <a href="#" id="admin-settings-btn" class="block px-4 py-2 text-slate-700 hover:bg-slate-100">Pengaturan Akun</a>
                               <div class="border-t border-slate-200"></div>
                               <a href="#" id="logout-btn" class="block px-4 py-2 text-rose-600 hover:bg-rose-50">Keluar</a>
                         </div>
                    </div>
                </div>
            </header>

            <!-- ### PAGE CONTAINER ### -->
            <div class="p-4 sm:p-6">

    <!-- Admin Settings Modal -->
    <div id="admin-settings-modal" class="modal-container fixed inset-0 bg-black/60 z-30 hidden flex items-center justify-center p-4 opacity-0 transition-opacity duration-300 ease-in-out">
        <div class="bg-slate-50 rounded-2xl shadow-2xl w-full max-w-lg modal-content transform scale-95 transition-transform duration-300 ease-in-out">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-5 border-b border-slate-200">
                <div class="flex items-center space-x-3">
                    <div class="bg-blue-100 p-2 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold text-slate-800">Pengaturan Akun Admin</h3>
                </div>
                <button class="close-modal-btn p-2 rounded-full text-slate-400 hover:bg-slate-200 hover:text-slate-800 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <!-- Modal Body -->
            <div class="p-6 space-y-6">
                <!-- Change Admin Name Form -->
                <form id="change-admin-name-form" class="space-y-4">
                    <h4 class="font-semibold text-slate-700">Ubah Nama Tampilan</h4>
                    <div>
                        <label for="current-admin-name" class="block mb-2 text-sm font-medium text-slate-600">Nama Admin Saat Ini</label>
                        <input type="text" id="current-admin-name" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg bg-slate-100 cursor-not-allowed" readonly>
                    </div>
                    <div>
                        <label for="new-admin-name" class="block mb-2 text-sm font-medium text-slate-600">Nama Admin Baru</label>
                        <input type="text" id="new-admin-name" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-5 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-150">Simpan Nama Baru</button>
                </form>

                <div class="border-t border-slate-200"></div>

                <!-- Change Password Form -->
                <form id="change-admin-password-form" class="space-y-4">
                    <h4 class="font-semibold text-slate-700">Ubah Kata Sandi</h4>
                    <div>
                        <label for="current-admin-password" class="block mb-2 text-sm font-medium text-slate-600">Kata Sandi Lama</label>
                        <input type="password" id="current-admin-password" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div>
                        <label for="new-admin-password" class="block mb-2 text-sm font-medium text-slate-600">Kata Sandi Baru</label>
                        <input type="password" id="new-admin-password" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div>
                        <label for="confirm-admin-password" class="block mb-2 text-sm font-medium text-slate-600">Konfirmasi Kata Sandi Baru</label>
                        <input type="password" id="confirm-admin-password" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-5 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-150">Ubah Kata Sandi</button>
                </form>
            </div>
        </div>
    </div>

                <!-- Page: Dasbor -->
                <div id="page-dasbor" class="page-content">
                    <!-- Stat Cards -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between">
                            <div>
                                <p class="text-sm text-slate-500">Total Pendapatan</p>
                                <p id="dashboard-total-revenue" class="text-2xl font-bold">Rp 0</p>
                            </div>
                            <div class="bg-emerald-100 p-3 rounded-full"><svg class="w-6 h-6 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01"></path></svg></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between">
                            <div>
                                <p class="text-sm text-slate-500">Pesanan Baru</p>
                                <p id="dashboard-new-orders" class="text-2xl font-bold">0</p>
                            </div>
                            <div class="bg-blue-100 p-3 rounded-full"><svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between">
                            <div>
                                <p class="text-sm text-slate-500">Total Produk</p>
                                <p id="dashboard-total-products" class="text-2xl font-bold">0</p>
                            </div>
                            <div class="bg-amber-100 p-3 rounded-full"><svg class="w-6 h-6 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between">
                            <div>
                                <p class="text-sm text-slate-500">Jumlah Anggota</p>
                                <p id="dashboard-total-customers" class="text-2xl font-bold">0</p>
                            </div>
                            <div class="bg-rose-100 p-3 rounded-full"><svg class="w-6 h-6 text-rose-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.653-.28-1.25-1.44-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.653.28-1.25 1.44-1.857M12 12a3 3 0 100-6 3 3 0 000 6z"></path></svg></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="bg-white p-4 rounded-xl shadow-md flex items-center justify-between">
                            <div><p class="text-sm text-gray-500">Total Stok Gudang</p><p id="kpi-total-stok" class="text-xl font-bold text-gray-800">0 Ton</p></div>
                            <div class="p-2 bg-amber-100 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg></div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-md flex items-center justify-between">
                            <div><p class="text-sm text-gray-500">Terjual Hari Ini</p><p id="kpi-terjual-hari-ini" class="text-xl font-bold text-gray-800">Rp 0</p></div>
                            <div class="p-2 bg-lime-100 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-lime-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg></div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-md flex items-center justify-between">
                            <div><p class="text-sm text-gray-500">Avg. Beli (Petani)</p><p id="kpi-harga-petani" class="text-xl font-bold text-gray-800">Rp 0</p></div>
                            <div class="p-2 bg-teal-100 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-teal-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg></div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-md flex items-center justify-between">
                            <div><p class="text-sm text-gray-500">Avg. Beli (BUMDes)</p><p id="kpi-harga-bumdes" class="text-xl font-bold text-gray-800">Rp 0</p></div>
                            <div class="p-2 bg-indigo-100 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h6m-6 4h6m-6 4h6" /></svg></div>
                        </div>
                    </div>
                    
                    <!-- Charts Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-6">
                        <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-md">
                            <div>
                                <h3 class="text-xl font-semibold">Grafik Harga Beli vs Jual</h3>
                                <p class="text-sm text-slate-500">Analisis harga rata-rata per Kg dalam 4 bulan terakhir.</p>
                            </div>
                            <div class="h-80 mt-4 bg-slate-50 p-4 rounded-lg"><canvas id="salesChart"></canvas></div>
                        </div>
                        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md">
                            <h3 class="text-xl font-semibold">Komposisi Nilai Stok</h3>
                            <p class="text-sm text-slate-500">Berdasarkan nilai (harga x stok) per kategori.</p>
                            <div class="h-80 mt-4 flex items-center justify-center"><canvas id="productPieChart"></canvas></div>
                        </div>
                    </div>

                    <!-- Commodity Category Summary Cards -->
                    <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                        <h3 class="text-xl font-semibold mb-4">Tinjauan Produk per Kategori</h3>
                        <div id="dashboard-category-summary-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            <!-- Category cards will be injected here by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Page: Produk -->
                <div id="page-produk" class="page-content hidden">
                    <div class="bg-white p-4 sm:p-6 rounded-xl shadow-md">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                            <div>
                                <h3 class="text-xl font-semibold">Semua Produk</h3>
                                <p class="text-sm text-slate-500">Kelola inventaris produk agrikultur Anda di sini.</p>
                            </div>
                            <button id="add-product-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-200 flex items-center w-full sm:w-auto">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                Tambah Produk
                            </button>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-2 mb-4">
                            <div class="relative flex-grow">
                                 <input type="search" id="product-search" placeholder="Cari berdasarkan nama produk..." class="pl-10 pr-4 py-2 w-full rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                                 <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg></div>
                            </div>
                            <select id="category-filter" class="px-4 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                                <!-- Category filter options will be loaded here -->
                            </select>
                        </div>
                        <div class="overflow-x-auto">
                            <table id="products-table" class="w-full text-left responsive-table">
                                <thead>
                                    <tr>
                                        <th class="p-3">Produk</th><th class="p-3">Kategori</th><th class="p-3">Harga</th><th class="p-3">Stok</th><th class="p-3">Status</th><th class="p-3">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody class="sm:divide-y">
                                    <!-- Product data will be loaded here by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Page: Stok Gudang -->
                <div id="page-stok-gudang" class="page-content hidden">
                    <div class="bg-white p-4 sm:p-6 rounded-xl shadow-md">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                            <div>
                                <h3 class="text-xl font-semibold">Monitoring Stok Gudang</h3>
                                <p class="text-sm text-slate-500">Lacak status ketersediaan semua produk di gudang.</p>
                            </div>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-2 mb-4">
                            <div class="relative flex-grow">
                                 <input type="search" id="stok-search" placeholder="Cari nama produk..." class="pl-10 pr-4 py-2 w-full rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                                 <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg></div>
                            </div>
                            <select id="stok-status-filter" class="px-4 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                                 <option value="">Semua Status</option>
                                 <option value="Aman">Aman</option>
                                 <option value="Menipis">Menipis</option>
                                 <option value="Habis">Habis</option>
                            </select>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-slate-50 text-xs uppercase text-slate-700">
                                    <tr><th class="p-3">Produk</th><th class="p-3">Kategori</th><th class="p-3 text-right">Stok Saat Ini</th><th class="p-3 text-center">Status</th><th class="p-3">Pembaruan Terakhir</th></tr>
                                </thead>
                                <tbody id="stok-gudang-table-body" class="divide-y"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Page: Pesanan -->
                <div id="page-pesanan" class="page-content hidden">
                    <div class="bg-white p-4 sm:p-6 rounded-xl shadow-md">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                            <div><h3 class="text-xl font-semibold">Semua Pesanan</h3><p class="text-sm text-slate-500">Lacak dan kelola semua pesanan pelanggan di sini.</p></div>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-2 mb-4">
                            <div class="relative flex-grow">
                                 <input type="search" id="order-search" placeholder="Cari ID Pesanan atau nama pelanggan..." class="pl-10 pr-4 py-2 w-full rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                                 <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg></div>
                            </div>
                            <select id="status-filter" class="px-4 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                                 <option value="">Semua Status</option>
                                 <option value="Menunggu Verifikasi">Menunggu Verifikasi</option>
                                 <option value="Menunggu Pembayaran Tunai">Menunggu Pembayaran Tunai</option>
                                 <option value="Menunggu Pembayaran">Menunggu Pembayaran</option>
                                 <option value="Diproses">Diproses</option>
                                 <option value="Dikirim">Dikirim</option>
                                 <option value="Selesai">Selesai</option>
                                 <option value="Dibatalkan">Dibatalkan</option>
                            </select>
                        </div>
                        <div class="overflow-x-auto">
                            <table id="orders-table" class="w-full text-left responsive-table">
                                <thead>
                                    <tr>
                                        <th class="p-3">ID Pesanan</th><th class="p-3">Pelanggan</th><th class="p-3">Tanggal</th><th class="p-3">Total</th><th class="p-3">Status</th><th class="p-3">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody class="sm:divide-y"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Page: Pelanggan -->
                <div id="page-pelanggan" class="page-content hidden">
                    <div class="bg-white p-4 sm:p-6 rounded-xl shadow-md">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                            <div>
                                <h3 class="text-xl font-semibold">Manajemen Anggota</h3>
                                <p class="text-sm text-slate-500">Lihat dan kelola semua data anggota koperasi.</p>
                            </div>
                            <button id="add-customer-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-200 flex items-center w-full sm:w-auto">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                Tambah Anggota
                            </button>
                        </div>

                        <!-- Search -->
                        <div class="relative mb-4">
                             <input type="search" id="customer-search" placeholder="Cari berdasarkan nama atau email anggota..." class="pl-10 pr-4 py-2 w-full max-w-sm rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                             <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                             </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table id="customers-table" class="w-full text-left responsive-table">
                                <thead>
                                    <tr>
                                        <th class="p-3">Anggota</th>
                                        <th class="p-3">Email</th>
                                        <th class="p-3">Bergabung</th>
                                        <th class="p-3">Status</th>
                                        <th class="p-3">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody class="sm:divide-y"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Page: Ulasan -->
                <div id="page-ulasan" class="page-content hidden">
                    <div class="bg-white p-4 sm:p-6 rounded-xl shadow-md">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                            <div>
                                <h3 class="text-xl font-semibold">Manajemen Ulasan Produk</h3>
                                <p class="text-sm text-slate-500">Lihat semua ulasan yang masuk dari pelanggan.</p>
                            </div>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-2 mb-4">
                            <div class="relative flex-grow">
                                 <input type="search" id="review-search" placeholder="Cari produk atau pelanggan..." class="pl-10 pr-4 py-2 w-full rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                                 <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg></div>
                            </div>
                            <select id="rating-filter" class="px-4 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                                <option value="">Semua Rating</option>
                                <option value="5">⭐⭐⭐⭐⭐ (5 Bintang)</option>
                                <option value="4">⭐⭐⭐⭐ (4 Bintang)</option>
                                <option value="3">⭐⭐⭐ (3 Bintang)</option>
                                <option value="2">⭐⭐ (2 Bintang)</option>
                                <option value="1">⭐ (1 Bintang)</option>
                            </select>
                        </div>
                        <div class="overflow-x-auto">
                            <table id="reviews-table" class="w-full text-left responsive-table">
                                <thead>
                                    <tr>
                                        <th class="p-3">Produk</th>
                                        <th class="p-3">Pelanggan</th>
                                        <th class="p-3">Rating</th>
                                        <th class="p-3">Ulasan</th>
                                        <th class="p-3">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody class="sm:divide-y"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Page: Kategori -->
                <div id="page-kategori" class="page-content hidden">
                    <div class="bg-white p-4 sm:p-6 rounded-xl shadow-md">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                            <div>
                                <h3 class="text-xl font-semibold">Daftar Kategori Produk</h3>
                                <p class="text-sm text-slate-500">Berikut adalah kategori utama yang digunakan dalam sistem.</p>
                            </div>
                            <button id="add-category-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-200 flex items-center w-full sm:w-auto">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                Tambah Kategori
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table id="categories-table" class="w-full text-left responsive-table">
                                <thead>
                                    <tr>
                                        <th class="p-3">Nama Kategori</th>
                                        <th class="p-3">Jumlah Produk</th>
                                    </tr>
                                </thead>
                                <tbody class="sm:divide-y"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Page: Pesan Permintaan (Baru) -->
                <div id="page-permintaan" class="page-content hidden">
                    <div class="bg-white p-4 sm:p-6 rounded-xl shadow-md">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                            <div>
                                <h3 class="text-xl font-semibold">Pesan Permintaan dari Pengguna</h3>
                                <p class="text-sm text-slate-500">Daftar permintaan komoditas yang belum tersedia di market.</p>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table id="requests-table" class="w-full text-left responsive-table">
                                <thead>
                                    <tr>
                                        <th class="p-3">Tanggal</th><th class="p-3">Pengguna</th><th class="p-3">Isi Permintaan</th><th class="p-3">Status</th><th class="p-3">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody class="sm:divide-y"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Modal Balas Permintaan (Baru) -->
                <div id="reply-request-modal" class="modal-container fixed inset-0 bg-black bg-opacity-50 z-30 hidden flex items-center justify-center p-4 modal-backdrop opacity-0">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg modal-content transform scale-95">
                        <div class="flex justify-between items-center p-6 border-b">
                            <h3 class="text-xl font-semibold">Balas Permintaan Komoditas</h3>
                            <button class="close-modal-btn text-slate-400 hover:text-slate-800 text-3xl leading-none">&times;</button>
                        </div>
                        <form id="reply-request-form" class="p-6 space-y-4">
                            <input type="hidden" id="reply-request-id">
                            <div class="bg-slate-50 p-3 rounded-lg border">
                                <p class="text-sm font-medium text-slate-500">Permintaan dari Pengguna:</p>
                                <p id="original-request-text" class="text-slate-700 italic mt-1"></p>
                            </div>
                            <textarea id="reply-details" rows="4" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Tulis balasan Anda di sini..." required></textarea>
                        </form>
                        <div class="flex justify-end items-center p-6 border-t space-x-2"><button class="cancel-btn px-4 py-2 bg-slate-200 rounded-lg hover:bg-slate-300 transition">Batal</button><button id="send-reply-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">Kirim Balasan</button></div>
                    </div>
                </div>

                <!-- Page: Notifikasi -->
                <div id="page-notifikasi" class="page-content hidden">
                    <div class="bg-white p-6 rounded-xl shadow-md max-w-2xl mx-auto">
                        <h3 class="text-xl font-semibold border-b pb-4 mb-4">Kirim Notifikasi ke Pengguna</h3>
                        <form id="notification-form" class="space-y-4">
                            <div>
                                <label for="notif-title" class="block mb-2 text-sm font-medium">Judul Notifikasi</label>
                                <input type="text" id="notif-title" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: Promo Spesial!" required>
                            </div>
                            <div>
                                <label for="notif-detail" class="block mb-2 text-sm font-medium">Detail Notifikasi</label>
                                <textarea id="notif-detail" rows="3" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Tulis pesan singkat di sini..." required></textarea>
                            </div>
                            <div>
                                <label for="notif-icon" class="block mb-2 text-sm font-medium">Ikon</label>
                                <select id="notif-icon" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="bell">Lonceng (Umum)</option><option value="tag">Tag (Promo)</option><option value="info">Info</option><option value="truck">Truk (Pengiriman)</option><option value="package-check">Paket (Selesai)</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full bg-emerald-500 text-white font-bold py-3 rounded-xl shadow-md hover:bg-emerald-600 transition duration-150">Kirim Notifikasi</button>
                        </form>
                    </div>
                </div>

                <!-- Page: Jadwal Tanam -->
                <div id="page-jadwal-tanam" class="page-content hidden">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-semibold">Manajemen Jadwal Tanam</h3>
                        <p class="text-slate-500 mt-2">Fitur ini sedang dalam pengembangan. Admin akan dapat melihat dan mengelola jadwal tanam petani di sini.</p>
                        <h3 class="text-xl font-semibold mb-4">Kalender Jadwal Tanam</h3>
                        <div id="planting-calendar"></div>
                    </div>
                </div>

                <!-- Page: Jadwal Panen -->
                <div id="page-jadwal-panen" class="page-content hidden">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-semibold">Manajemen Jadwal Panen</h3>
                        <p class="text-slate-500 mt-2">Fitur ini sedang dalam pengembangan. Admin akan dapat melihat dan mengelola jadwal panen petani di sini.</p>
                        <h3 class="text-xl font-semibold mb-4">Kalender Jadwal Panen</h3>
                        <div id="harvesting-calendar"></div>
                    </div>
                </div>

                <!-- Page: Luas Lahan -->
                <div id="page-luas-lahan" class="page-content hidden">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-semibold mb-4">Laporan Luas Lahan Anggota Petani</h3>
                        <p class="text-sm text-slate-500 mb-6">Halaman ini menampilkan data luas lahan yang diinput oleh petani melalui aplikasi mereka. Admin hanya dapat memantau data ini.</p>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left responsive-table">
                                <thead>
                                    <tr>
                                        <th class="p-3">Petani/Kelompok</th><th class="p-3">Lokasi</th><th class="p-3 text-right">Luas</th><th class="p-3">Komoditas Utama</th><th class="p-3">Status Lahan</th>
                                    </tr>
                                </thead>
                                <tbody id="land-area-table-body" class="sm:divide-y"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Page: Info Penawaran -->
                <div id="page-info-penawaran" class="page-content hidden">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-semibold mb-4">Info Penawaran dari Petani</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left responsive-table">
                                <thead>
                                    <tr>
                                        <th class="p-3">Petani/Kelompok</th>
                                        <th class="p-3">Produk</th>
                                        <th class="p-3 text-right">Jumlah</th>
                                        <th class="p-3">Harga Penawaran</th>
                                        <th class="p-3">Tanggal Panen</th>
                                        <th class="p-3">Status</th>
                                        <th class="p-3">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="farmer-offers-table-body" class="sm:divide-y"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Page: Kebutuhan Stok -->
                <div id="page-kebutuhan-stok" class="page-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md">
                            <h3 class="text-xl font-semibold mb-4">Daftar Kebutuhan Stok Aktif</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left responsive-table">
                                    <thead><tr><th class="p-3">Produk</th><th class="p-3 text-right">Jumlah</th><th class="p-3">Rentang Harga</th><th class="p-3">Tgl Posting</th><th class="p-3">Status</th><th class="p-3">Aksi</th></tr></thead>
                                    <tbody id="stock-needs-table-body" class="sm:divide-y"></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md">
                            <h3 class="text-xl font-semibold mb-4">Posting Kebutuhan Baru</h3>
                            <form id="post-stock-need-form" class="space-y-4">
                                <div><label for="need-product-name" class="block mb-1 text-sm font-medium">Nama Produk</label><input type="text" id="need-product-name" class="w-full px-3 py-2 border rounded-lg" required></div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label for="need-quantity" class="block mb-1 text-sm font-medium">Jumlah</label><input type="number" id="need-quantity" class="w-full px-3 py-2 border rounded-lg" required></div>
                                    <div><label for="need-unit" class="block mb-1 text-sm font-medium">Unit</label><input type="text" id="need-unit" placeholder="Ton/Kg/Butir" class="w-full px-3 py-2 border rounded-lg" required></div>
                                </div>
                                <div><label for="need-price-range" class="block mb-1 text-sm font-medium">Rentang Harga Beli</label><input type="text" id="need-price-range" placeholder="Rp 4.000 - Rp 4.500" class="w-full px-3 py-2 border rounded-lg" required></div>
                                <button type="submit" class="w-full bg-blue-500 text-white font-bold py-3 rounded-xl shadow-md hover:bg-blue-600 transition">Posting Kebutuhan</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Page: Simpan Pinjam -->
                <div id="page-simpanan" class="page-content hidden">
                    <div class="bg-white p-4 sm:p-6 rounded-xl shadow-md">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                            <div>
                                <h3 class="text-xl font-semibold">Manajemen Simpanan Anggota</h3>
                                <p class="text-sm text-slate-500">Kelola semua transaksi simpanan anggota koperasi.</p>
                            </div>
                            <button id="add-savings-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-200 flex items-center w-full sm:w-auto">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                Transaksi Baru
                            </button>
                        </div>
                        <div class="relative mb-4">
                             <input type="search" id="savings-search" placeholder="Cari nama anggota..." class="pl-10 pr-4 py-2 w-full max-w-sm rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                             <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                             </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table id="savings-table" class="w-full text-left responsive-table">
                                <thead>
                                    <tr>
                                        <th class="p-3">Anggota</th>
                                        <th class="p-3 text-right">Simpanan Pokok</th>
                                        <th class="p-3 text-right">Simpanan Wajib</th>
                                        <th class="p-3 text-right">Simpanan Sukarela</th>
                                        <th class="p-3 text-right">Total Simpanan</th>
                                        <th class="p-3">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody class="sm:divide-y"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Page: Pinjaman (Placeholder) -->
                <div id="page-pinjaman" class="page-content hidden space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-md"><h4 class="text-sm text-slate-500">Total Nilai Pinjaman</h4><p id="loan-total-amount" class="text-2xl font-bold">Rp 0</p></div>
                        <div class="bg-white p-6 rounded-xl shadow-md"><h4 class="text-sm text-slate-500">Pinjaman Aktif</h4><p id="loan-active-count" class="text-2xl font-bold">0</p></div>
                        <div class="bg-white p-6 rounded-xl shadow-md"><h4 class="text-sm text-slate-500">Pinjaman Lunas</h4><p id="loan-completed-count" class="text-2xl font-bold">0</p></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                            <div>
                                <h3 class="text-xl font-semibold">Manajemen Pinjaman Anggota</h3>
                                <p class="text-sm text-slate-500">Kelola semua data pinjaman anggota koperasi.</p>
                            </div>
                            <button id="add-loan-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-200 flex items-center w-full sm:w-auto">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                Ajukan Pinjaman
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left responsive-table">
                                <thead>
                                    <tr>
                                        <th class="p-3">Anggota</th>
                                        <th class="p-3 text-right">Jumlah Pinjaman</th>
                                        <th class="p-3 text-right">Angsuran</th>
                                        <th class="p-3 text-right">Sisa Tagihan</th>
                                        <th class="p-3">Progres</th>
                                        <th class="p-3 text-center">Status</th>
                                        <th class="p-3 text-right">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="loans-table-body" class="sm:divide-y"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Page: Laporan -->
                <div id="page-laporan" class="page-content hidden">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <div>
                                <h3 class="text-xl font-semibold">Laporan Pemantauan Kinerja</h3>
                                <p class="text-sm text-slate-500">Analisis kinerja penjualan untuk pemangku kepentingan.</p>
                            </div>
                            <button id="export-report-btn-laporan" class="bg-emerald-500 text-white px-4 py-2 rounded-lg hover:bg-emerald-600 transition duration-200 flex items-center w-full sm:w-auto">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                Ekspor ke CSV
                            </button>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-4 mb-6 flex-wrap">
                            <div>
                                <label for="start-date-laporan" class="block text-sm font-medium mb-1">Tanggal Mulai</label>
                                <input type="date" id="start-date-laporan" value="2025-09-01" class="px-3 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                            </div>
                             <div>
                                <label for="end-date-laporan" class="block text-sm font-medium mb-1">Tanggal Selesai</label>
                                <input type="date" id="end-date-laporan" value="2025-09-30" class="px-3 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                            </div>
                        </div>
                        <div class="h-96 bg-slate-50 p-4 rounded-lg"><canvas id="salesChartLaporan"></canvas></div>
                    </div>
                </div>



                <!-- Page: Perumda -->
                <div id="page-perumda" class="page-content hidden">
                    <div class="bg-white p-4 sm:p-6 rounded-xl shadow-md">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                            <div>
                                <h3 class="text-xl font-semibold">Pesanan dari Perumda</h3>
                                <p class="text-sm text-slate-500">Kelola pesanan yang masuk dari Perumda.</p>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table id="perumda-orders-table" class="w-full text-left responsive-table">
                                <thead>
                                    <tr>
                                        <th class="p-3">ID Transaksi</th><th class="p-3">Pelanggan</th><th class="p-3">Tanggal</th><th class="p-3">Total</th><th class="p-3">Status</th><th class="p-3">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody class="sm:divide-y"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <!-- Page: Metode Pembayaran (Baru) -->
                <div id="page-metode-pembayaran" class="page-content hidden">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-semibold border-b pb-4 mb-4">Pengaturan Metode Pembayaran</h3>
                        <p class="text-sm text-slate-500 mb-6">Aktifkan atau nonaktifkan metode pembayaran yang akan tersedia untuk pelanggan di aplikasi.</p>
                        <div id="payment-methods-container" class="space-y-5">
                            <!-- Konten metode pembayaran akan di-generate oleh JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Page: Riwayat Pembelian -->
                <div id="page-pembelian" class="page-content hidden">
                    <div class="bg-white p-4 sm:p-6 rounded-xl shadow-md">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                            <div><h3 class="text-xl font-semibold">Riwayat Pembelian</h3><p class="text-sm text-slate-500">Lacak semua riwayat pembelian bahan baku dari pemasok.</p></div>
                            <button id="add-purchase-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-200 flex items-center w-full sm:w-auto">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path></svg>
                                Catat Pembelian
                            </button>
                        </div>
                        <!-- Filter Section -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 p-4 bg-slate-50 rounded-lg border">
                            <div class="md:col-span-1">
                                <label for="purchase-search" class="block text-sm font-medium text-gray-700 mb-1">Cari Pemasok/Produk</label>
                                <input type="search" id="purchase-search" placeholder="Ketik untuk mencari..." class="w-full p-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="purchase-start-date" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Mulai</label>
                                <input type="date" id="purchase-start-date" class="w-full p-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div><label for="purchase-end-date" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Selesai</label><input type="date" id="purchase-end-date" class="w-full p-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                        </div>
                        <div class="overflow-x-auto">
                            <table id="purchases-table" class="w-full text-left responsive-table">
                                <thead>
                                    <tr>
                                        <th class="p-3">Tanggal</th><th class="p-3">Pemasok</th><th class="p-3">Produk</th><th class="p-3 text-right">Jumlah</th><th class="p-3 text-right">Harga Beli</th><th class="p-3 text-right">Total</th>
                                    </tr>
                                </thead>
                                <tbody class="sm:divide-y"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
            <footer class="text-center p-4 text-sm text-slate-500 mt-auto">
                &copy; 2025 Gerbang Pangan Indonesia. Seluruh Hak Cipta.
            </footer>
        </main>
    </div>

    <!-- ### MODALS ### -->
    <!-- Add/Edit Product Modal -->
    <div id="product-modal" class="modal-container fixed inset-0 bg-black bg-opacity-50 z-30 hidden flex items-center justify-center p-4 modal-backdrop opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg modal-content transform scale-95">
            <div class="flex justify-between items-center p-6 border-b">
                <h3 id="product-modal-title" class="text-xl font-semibold">Tambah Produk Baru</h3>
                <button class="close-modal-btn text-slate-400 hover:text-slate-800 text-3xl leading-none">&times;</button>
            </div>
            <form id="product-form" class="p-6 space-y-4">
                <input type="hidden" id="product-id">
                <div>
                    <label for="product-name" class="block mb-2 text-sm font-medium">Nama Produk</label>
                    <input type="text" id="product-name" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: Sayur Sawi" required>
                </div>
                <div>
                    <label class="block mb-2 text-sm font-medium">Gambar Produk</label>
                    <div class="flex items-center space-x-4">
                        <div id="product-image-preview" class="w-20 h-20 bg-slate-100 rounded-lg flex items-center justify-center border">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        </div>
                        <label for="product-image-upload" class="cursor-pointer text-sm text-blue-600 font-semibold hover:text-blue-800">
                            Pilih file untuk diunggah
                            <input type="file" id="product-image-upload" class="hidden" accept="image/*">
                        </label>
                    </div>
                    <input type="hidden" id="product-image-base64">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="product-category" class="block mb-2 text-sm font-medium">Kategori</label>
                        <select id="product-category" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required></select>
                    </div>
                    <div>
                         <label for="product-price" class="block mb-2 text-sm font-medium">Harga (Rp)</label>
                         <input type="number" id="product-price" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="13000" required>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="sm:col-span-1">
                        <label for="product-stock" class="block mb-2 text-sm font-medium">Stok</label>
                        <input type="number" id="product-stock" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="200" required>
                    </div>
                    <div>
                        <label for="product-unit" class="block mb-2 text-sm font-medium">Unit</label>
                        <input type="text" id="product-unit" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Kg" required>
                    </div>
                    <div>
                        <label for="product-threshold" class="block mb-2 text-sm font-medium">Ambang Batas</label>
                        <input type="number" id="product-threshold" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="50" required>
                    </div>
                </div>
                <div>
                    <label for="product-description" class="block mb-2 text-sm font-medium">Deskripsi</label>
                    <textarea id="product-description" rows="3" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Masukkan deskripsi produk"></textarea>
                </div>
            </form>
            <div class="flex justify-end items-center p-6 border-t space-x-2">
                <button class="cancel-btn px-4 py-2 bg-slate-200 rounded-lg hover:bg-slate-300 transition">Batal</button>
                <button id="save-product-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition flex items-center justify-center w-36">
                    <span class="btn-text">Simpan</span>
                    <svg class="animate-spin h-5 w-5 text-white hidden btn-spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="delete-confirm-modal" class="modal-container fixed inset-0 bg-black bg-opacity-50 z-30 hidden flex items-center justify-center p-4 modal-backdrop opacity-0">
         <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm modal-content transform scale-95"><div class="p-6 text-center"><svg class="mx-auto mb-4 w-14 h-14 text-rose-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><h3 id="delete-confirm-text" class="mb-5 text-lg font-normal">Anda yakin ingin menghapus item ini?</h3><button id="confirm-delete-btn" class="text-white bg-rose-600 hover:bg-rose-800 font-medium rounded-lg text-sm inline-flex items-center px-5 py-2.5 text-center mr-2 transition">Ya, saya yakin</button><button class="cancel-btn text-slate-500 bg-white hover:bg-slate-100 rounded-lg border border-slate-200 text-sm font-medium px-5 py-2.5 hover:text-slate-900 transition">Tidak</button></div></div>
    </div>

    <!-- Order Detail Modal -->
    <div id="order-detail-modal" class="modal-container fixed inset-0 bg-black bg-opacity-50 z-30 hidden flex items-center justify-center p-4 modal-backdrop opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl modal-content transform scale-95 max-h-[90vh] flex flex-col"><div class="flex justify-between items-center p-6 border-b flex-shrink-0"><h3 id="order-detail-title" class="text-xl font-semibold">Detail Pesanan</h3><button class="close-modal-btn text-slate-400 hover:text-slate-800 text-3xl leading-none">&times;</button></div><div class="p-6 space-y-6 overflow-y-auto"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><h4 class="font-semibold mb-2">Informasi Pelanggan</h4><div id="order-detail-customer-info" class="text-sm space-y-1"></div></div><div><h4 class="font-semibold mb-2">Ringkasan Pesanan</h4><div id="order-detail-summary-info" class="text-sm space-y-1"></div></div></div><div><h4 class="font-semibold mb-2">Item yang Dipesan</h4><div class="overflow-x-auto border rounded-lg"><table class="w-full text-left text-sm"><thead class="bg-slate-50"><tr><th class="p-3">Produk</th><th class="p-3 text-center">Jumlah</th><th class="p-3 text-right">Harga Satuan</th><th class="p-3 text-right">Subtotal</th></tr></thead><tbody id="order-detail-items-table" class="divide-y"></tbody></table></div></div><div id="rating-display" class="hidden"><h4 class="font-semibold mb-2">Ulasan Pelanggan</h4><div class="text-sm space-y-1 bg-slate-50 p-3 rounded-lg"><p><strong>Rating:</strong> <span id="rating-stars" class="text-amber-400"></span></p><p><strong>Komentar:</strong> <span id="rating-comment" class="italic"></span></p></div></div></div><div class="flex flex-col sm:flex-row justify-between items-center p-6 border-t space-y-2 sm:space-y-0 sm:space-x-2 flex-shrink-0"><div class="flex items-center gap-2"><label for="update-status" class="text-sm font-medium">Ubah Status:</label><select id="update-status" class="w-full sm:w-auto px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"><option>Menunggu Pembayaran</option><option>Diproses</option><option>Dikirim</option><option>Selesai</option><option>Dibatalkan</option></select></div><div><button class="cancel-btn px-4 py-2 bg-slate-200 rounded-lg hover:bg-slate-300 transition">Tutup</button><button id="save-order-status-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">Simpan Perubahan</button></div></div></div>
    </div>

    <!-- Add/Edit Customer Modal -->
    <div id="customer-modal" class="modal-container fixed inset-0 bg-black bg-opacity-50 z-30 hidden flex items-center justify-center p-4 modal-backdrop opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md modal-content transform scale-95">
            <div class="flex justify-between items-center p-6 border-b">
                <h3 id="customer-modal-title" class="text-xl font-semibold">Tambah Anggota Baru</h3>
                <button class="close-modal-btn text-slate-400 hover:text-slate-800 text-3xl leading-none">&times;</button>
            </div>
            <form id="customer-form" class="p-6 space-y-4">
                <input type="hidden" id="customer-id">
                <div>
                    <label for="customer-name" class="block mb-2 text-sm font-medium">Nama Lengkap</label>
                    <input type="text" id="customer-name" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: Budi Santoso" required>
                </div>
                <div>
                    <label for="customer-email" class="block mb-2 text-sm font-medium">Email</label>
                    <input type="email" id="customer-email" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="contoh@email.com" required>
                </div>
                <div>
                    <label for="customer-phone" class="block mb-2 text-sm font-medium">Nomor Telepon</label>
                    <input type="tel" id="customer-phone" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0812xxxxxxxx">
                </div>
                <div id="customer-password-section" class="space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="customer-password" class="block mb-2 text-sm font-medium">Kata Sandi</label>
                            <input type="password" id="customer-password" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Min. 6 karakter">
                        </div>
                        <div>
                            <label for="customer-confirm-password" class="block mb-2 text-sm font-medium">Konfirmasi Kata Sandi</label>
                            <input type="password" id="customer-confirm-password" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ulangi kata sandi">
                        </div>
                    </div>
                    <p id="password-error-msg" class="text-red-500 text-xs hidden"></p>
                </div>
                 <div id="customer-management-section" class="hidden border-t pt-4">
                      <p class="text-sm font-medium text-slate-700 mb-2">Manajemen Akun</p>
                      <button type="button" id="reset-password-btn" class="w-full text-left px-4 py-2 text-sm text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-lg transition">Kirim Link Reset Password</button>
                 </div>
            </form>
        <script>
            document.getElementById('reset-password-btn').addEventListener('click', function() {
                const customerId = parseInt(document.getElementById('customer-id').value);
                if (!customerId) return;

                let customers = getFromDB(DB_CUSTOMERS_KEY);
                const customerIndex = customers.findIndex(c => c.id === customerId);

                if (customerIndex > -1) {
                    // Buat token reset sederhana dan waktu kedaluwarsa (15 menit)
                    const token = 'RESET-' + Date.now().toString(36);
                    const expiry = new Date(new Date().getTime() + 15 * 60 * 1000);

                    customers[customerIndex].resetToken = token;
                    customers[customerIndex].resetTokenExpiry = expiry.toISOString();

                    saveToDB(DB_CUSTOMERS_KEY, customers);

                    // Simulasi pengiriman email/SMS
                    alert(`Token Reset Password untuk ${customers[customerIndex].name} telah dibuat.\n\nBerikan token ini kepada pengguna:\n${token}\n\nToken ini akan kedaluwarsa dalam 15 menit.`);
                }
            });
        </script>
            <div class="flex justify-end items-center p-6 border-t space-x-2">
                <button class="cancel-btn px-4 py-2 bg-slate-200 rounded-lg hover:bg-slate-300 transition">Batal</button>
                <button id="save-customer-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">Simpan</button>
            </div>
        </div>
    </div>

     <!-- Savings Transaction Modal -->
    <div id="savings-transaction-modal" class="modal-container fixed inset-0 bg-black bg-opacity-50 z-30 hidden items-center justify-center p-4 modal-backdrop opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md modal-content transform scale-95">
            <div class="flex justify-between items-center p-6 border-b">
                <h3 class="text-xl font-semibold">Transaksi Simpanan Baru</h3>
                <button class="close-modal-btn text-slate-400 hover:text-slate-800 text-3xl leading-none">&times;</button>
            </div>
            <form class="p-6 space-y-4">
                <div>
                    <label for="savings-member-select" class="block mb-2 text-sm font-medium">Pilih Anggota</label>
                    <select id="savings-member-select" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                </div>
                <div>
                    <label class="block mb-2 text-sm font-medium">Jenis Transaksi</label>
                    <div class="flex gap-4">
                        <label class="flex items-center"><input type="radio" name="savings-action" value="deposit" class="text-blue-500 focus:ring-blue-500" checked><span class="ml-2">Setoran</span></label>
                        <label class="flex items-center"><input type="radio" name="savings-action" value="withdraw" class="text-rose-500 focus:ring-rose-500"><span class="ml-2">Penarikan</span></label>
                    </div>
                </div>
                <div>
                    <label for="savings-type" class="block mb-2 text-sm font-medium">Jenis Simpanan</label>
                    <select id="savings-type" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="wajib">Simpanan Wajib</option>
                        <option value="sukarela">Simpanan Sukarela</option>
                    </select>
                </div>
                <div>
                    <label for="savings-amount" class="block mb-2 text-sm font-medium">Jumlah (Rp)</label>
                    <input type="number" id="savings-amount" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Masukkan jumlah">
                </div>
            </form>
            <div class="flex justify-end items-center p-6 border-t space-x-2">
                <button class="cancel-btn px-4 py-2 bg-slate-200 rounded-lg hover:bg-slate-300 transition">Batal</button>
                <button id="process-savings-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">Proses Transaksi</button>
            </div>
        </div>
    </div>

    <!-- Add Voucher Modal -->
    <div id="add-voucher-modal" class="modal-container fixed inset-0 bg-black bg-opacity-50 z-30 hidden items-center justify-center p-4 modal-backdrop opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md modal-content transform scale-95">
            <div class="flex justify-between items-center p-6 border-b">
                <h3 class="text-xl font-semibold">Tambah Voucher Baru</h3>
                <button class="close-modal-btn text-slate-400 hover:text-slate-800 text-3xl leading-none">&times;</button>
            </div>
            <form class="p-6 space-y-4">
                <div>
                    <label for="voucher-code-input" class="block mb-2 text-sm font-medium">Kode Voucher</label>
                    <input type="text" id="voucher-code-input" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: PANENRAYA20">
                </div>
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="voucher-type" class="block mb-2 text-sm font-medium">Jenis Diskon</label>
                        <select id="voucher-type" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="percentage">Persentase (%)</option>
                            <option value="fixed">Nominal (Rp)</option>
                        </select>
                    </div>
                    <div>
                        <label for="voucher-value" class="block mb-2 text-sm font-medium">Nilai Diskon</label>
                        <input type="number" id="voucher-value" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: 15 atau 20000">
                    </div>
                </div>
            </form>
            <div class="flex justify-end items-center p-6 border-t space-x-2">
                <button class="cancel-btn px-4 py-2 bg-slate-200 rounded-lg hover:bg-slate-300 transition">Batal</button>
                <button id="save-voucher-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">Simpan Voucher</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Category Modal -->
    <div id="category-modal" class="modal-container fixed inset-0 bg-black bg-opacity-50 z-30 hidden flex items-center justify-center p-4 modal-backdrop opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md modal-content transform scale-95">
            <div class="flex justify-between items-center p-6 border-b">
                <h3 id="category-modal-title" class="text-xl font-semibold">Tambah Kategori Baru</h3>
                <button class="close-modal-btn text-slate-400 hover:text-slate-800 text-3xl leading-none">&times;</button>
            </div>
            <form class="p-6 space-y-4">
                <input type="hidden" id="original-category-name">
                <div>
                    <label for="category-name-input" class="block mb-2 text-sm font-medium">Nama Kategori</label>
                    <input type="text" id="category-name-input" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: Sayuran Segar">
                </div>
            </form>
            <div class="flex justify-end items-center p-6 border-t space-x-2">
                <button class="cancel-btn px-4 py-2 bg-slate-200 rounded-lg hover:bg-slate-300 transition">Batal</button>
                <button id="save-category-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition flex items-center justify-center w-36">
                     <span class="btn-text">Simpan</span>
                     <svg class="animate-spin h-5 w-5 text-white hidden btn-spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                         <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                         <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                     </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Loan Modal -->
    <div id="loan-modal" class="modal-container fixed inset-0 bg-black bg-opacity-50 z-30 hidden items-center justify-center p-4 modal-backdrop opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg modal-content transform scale-95">
            <div class="flex justify-between items-center p-6 border-b"><h3 id="loan-modal-title" class="text-xl font-semibold">Pengajuan Pinjaman Baru</h3><button class="close-modal-btn text-slate-400 hover:text-slate-800 text-3xl leading-none">&times;</button></div>
            <form id="loan-form" class="p-6 space-y-4">
                <input type="hidden" id="loan-id">
                <div>
                    <label for="loan-member-select" class="block mb-2 text-sm font-medium">Pilih Anggota</label>
                    <select id="loan-member-select" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required></select>
                </div>
                <div>
                    <label for="loan-amount" class="block mb-2 text-sm font-medium">Jumlah Pinjaman (Rp)</label>
                    <input type="number" id="loan-amount" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: 5000000" required>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="loan-term" class="block mb-2 text-sm font-medium">Tenor (Bulan)</label>
                        <input type="number" id="loan-term" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: 12" required>
                    </div>
                    <div>
                        <label for="loan-interest" class="block mb-2 text-sm font-medium">Bunga per Bulan (%)</label>
                        <input type="number" step="0.1" id="loan-interest" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: 1.5" required>
                    </div>
                </div>
            </form>
            <div class="flex justify-end items-center p-6 border-t space-x-2"><button class="cancel-btn px-4 py-2 bg-slate-200 rounded-lg hover:bg-slate-300 transition">Batal</button><button id="save-loan-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">Simpan Pengajuan</button></div>
        </div>
    </div>

    <!-- Loan Detail Modal -->
    <div id="loan-detail-modal" class="modal-container fixed inset-0 bg-black bg-opacity-50 z-30 hidden items-center justify-center p-4 modal-backdrop opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl modal-content transform scale-95 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-6 border-b flex-shrink-0">
                <h3 id="loan-detail-title" class="text-xl font-semibold">Detail Pinjaman</h3>
                <button class="close-modal-btn text-slate-400 hover:text-slate-800 text-3xl leading-none">&times;</button>
            </div>
            <div id="loan-detail-content" class="p-6 space-y-6 overflow-y-auto">
                <!-- Content will be injected by JS -->
            </div>
            <div class="flex justify-end items-center p-6 border-t space-x-2 flex-shrink-0">
                <button class="cancel-btn px-4 py-2 bg-slate-200 rounded-lg hover:bg-slate-300 transition">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Purchase Modal -->
    <div id="purchase-modal" class="modal-container fixed inset-0 bg-black bg-opacity-50 z-30 hidden items-center justify-center p-4 modal-backdrop opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg modal-content transform scale-95">
            <div class="flex justify-between items-center p-6 border-b"><h3 class="text-xl font-semibold">Catat Pembelian Baru</h3><button class="close-modal-btn text-slate-400 hover:text-slate-800 text-3xl leading-none">&times;</button></div>
            <form id="purchase-form" class="p-6 space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div><label for="purchase-date" class="block mb-2 text-sm font-medium">Tanggal Pembelian</label><input type="date" id="purchase-date" class="w-full px-3 py-2 border rounded-lg" required></div>
                    <div><label for="purchase-supplier" class="block mb-2 text-sm font-medium">Nama Pemasok</label><input type="text" id="purchase-supplier" class="w-full px-3 py-2 border rounded-lg" placeholder="Cth: Kelompok Tani Maju" required></div>
                </div>
                <div><label for="purchase-product-name" class="block mb-2 text-sm font-medium">Nama Produk Dibeli</label><input type="text" id="purchase-product-name" class="w-full px-3 py-2 border rounded-lg" placeholder="Cth: Gabah Kering Panen" required></div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div><label for="purchase-quantity" class="block mb-2 text-sm font-medium">Jumlah</label><input type="number" id="purchase-quantity" class="w-full px-3 py-2 border rounded-lg" required></div>
                    <div><label for="purchase-unit" class="block mb-2 text-sm font-medium">Unit</label><input type="text" id="purchase-unit" placeholder="Ton/Kg" class="w-full px-3 py-2 border rounded-lg" required></div>
                    <div><label for="purchase-price" class="block mb-2 text-sm font-medium">Harga Beli / Unit (Rp)</label><input type="number" id="purchase-price" class="w-full px-3 py-2 border rounded-lg" required></div>
                </div>
            </form>
            <div class="flex justify-end items-center p-6 border-t space-x-2">
                <button class="cancel-btn px-4 py-2 bg-slate-200 rounded-lg hover:bg-slate-300 transition">Batal</button>
                <button id="save-purchase-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition flex items-center justify-center w-36">
                    <span class="btn-text">Simpan</span>
                    <svg class="animate-spin h-5 w-5 text-white hidden btn-spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Alert/Toast Container -->
    <div id="alert-container" class="fixed top-5 right-5 z-50 space-y-2"></div>
    
    <script>
        // --- DATABASE SIMULATION & KEYS ---
        const DB_PRODUCTS_KEY = 'gerbangPanganProducts';
        const DB_BANNERS_KEY = 'appBanners';
        const DB_CUSTOMERS_KEY = 'gerbangPanganCustomers';
        const DB_ORDERS_KEY = 'transactionHistory';
        const DB_NOTIFICATIONS_KEY = 'appNotifications';
        const DB_CATEGORIES_KEY = 'gerbangPanganCategories';
        const DB_VOUCHERS_KEY = 'gerbangPanganVouchers';
        const DB_FARMER_OFFERS_KEY = 'gerbangPanganFarmerOffers';
        const DB_STOCK_NEEDS_KEY = 'gerbangPanganStockNeeds';
        const DB_REQUESTS_KEY = 'gerbangPanganProductRequests'; // Kunci baru
        const DB_SCHEDULES_KEY = 'gerbangPanganSchedules';
        const DB_LAND_AREAS_KEY = 'gerbangPanganLandAreas';
        const DB_LOANS_KEY = 'gerbangPanganLoans';
        const DB_PURCHASES_KEY = 'gerbangPanganPurchases'; // Kunci baru untuk riwayat pembelian
        const DB_PERUMDA_ORDERS_KEY = 'perumdaOrders'; // Menambahkan key untuk pesanan Perumda
        const DB_PAYMENT_METHODS_KEY = 'gerbangPanganPaymentMethods';
        const DB_EXTERNAL_USERS_KEY = 'pemdaExternalUsers'; // Kunci baru untuk sinkronisasi

        // --- FUNGSI BARU UNTUK GRAFIK DASBOR ---

        // --- INITIAL DATA (Used only if localStorage is empty) ---
        const INITIAL_PRODUCTS = [
            // Data produk dummy dikembalikan untuk keperluan sampel
            // Pertanian
            { id: 1, name: 'Bawang Merah (Bima)', image: 'https://i.pinimg.com/736x/5d/ef/d1/5defd1c4e7691335e337e556d9654d02.jpg', stock: 5000, unit: 'Kg', threshold: 1000, price: 28000, category: 'Pertanian', description: 'Bawang merah kualitas super dari Bima, cocok untuk bumbu masakan grosir.', lastUpdate: new Date().toISOString(), koperasiAsal: "Koperasi Ampibabo" },
            { id: 2, name: 'Kentang Dieng Super', image: 'https://i.pinimg.com/1200x/16/fd/14/16fd14d1a058705140f9a3a62bdce65c.jpg', stock: 10000, unit: 'Kg', threshold: 2000, price: 15000, category: 'Pertanian', description: 'Kentang segar ukuran besar dari dataran tinggi Dieng, minim cacat.', lastUpdate: new Date().toISOString(), koperasiAsal: "Koperasi Ampibabo" },
            { id: 3, name: 'Cabai Rawit Merah', image: 'https://i.pinimg.com/736x/7c/2e/a2/7c2ea2bf91bbb3868c9a5bf59e5507af.jpg', stock: 2000, unit: 'Kg', threshold: 500, price: 65000, category: 'Pertanian', description: 'Cabai rawit pedas, kualitas ekspor untuk industri sambal dan restoran.', lastUpdate: new Date().toISOString(), koperasiAsal: "Koperasi Ampibabo" },
            { id: 10, name: 'Beras IR-64 Premium', image: 'https://i.pinimg.com/1200x/97/c5/76/97c57658eb1dd7675ef300cd91ad1b57.jpg', stock: 20, unit: 'Ton', threshold: 5, price: 12500, category: 'Pertanian', description: 'Beras IR-64 kualitas premium, pulen dan bersih, dalam kemasan 50Kg.', lastUpdate: new Date().toISOString(), koperasiAsal: "Koperasi Ampibabo" },
            { id: 16, name: 'Bibit Jagung Hibrida', image: 'https://i.pinimg.com/1200x/0e/80/3c/0e803c330fa5c7553705069cfcecee06.jpg', stock: 2000, unit: 'Kg', threshold: 400, price: 85000, category: 'Pertanian', description: 'Bibit jagung hibrida varietas unggul, daya tumbuh tinggi.', lastUpdate: new Date().toISOString(), koperasiAsal: "Koperasi Ampibabo" },

            // Perkebunan
            { id: 4, name: 'Kopi Robusta (Biji)', image: 'https://i.pinimg.com/736x/87/b8/47/87b84788c817408c9241839b876a08c7.jpg', stock: 1500, unit: 'Kg', threshold: 300, price: 35000, category: 'Perkebunan', description: 'Biji kopi robusta grade A, cocok untuk roasting.', lastUpdate: new Date().toISOString(), koperasiAsal: "Koperasi Ampibabo" },
            { id: 11, name: 'Minyak Sawit (CPO)', image: 'https://i.pinimg.com/736x/33/64/43/336443155f2ed7fe66d862b8589d06bc.jpg', stock: 15000, unit: 'Liter', threshold: 3000, price: 14000, category: 'Perkebunan', description: 'Crude Palm Oil untuk industri.', lastUpdate: new Date().toISOString(), koperasiAsal: "Koperasi Ampibabo" },
            { id: 12, name: 'Gula Tebu Kristal', image: 'https://i.pinimg.com/736x/aa/80/b4/aa80b444fc22c58032e6963b57880b0e.jpg', stock: 12, unit: 'Ton', threshold: 2, price: 16500, category: 'Perkebunan', description: 'Gula pasir dari tebu, kemasan karung 50Kg.', lastUpdate: new Date().toISOString(), koperasiAsal: "Koperasi Ampibabo" },
            
            // Perikanan
            { id: 6, name: 'Ikan Tuna (Sirip Kuning)', image: 'https://i.pinimg.com/1200x/1e/34/22/1e3422eec9ad1012bdf82680146c7a7d.jpg', stock: 800, unit: 'Kg', threshold: 100, price: 75000, category: 'Perikanan', description: 'Ikan tuna segar, cocok untuk sashimi atau steak, pasokan untuk restoran.', lastUpdate: new Date().toISOString(), koperasiAsal: "Koperasi Ampibabo" },
            { id: 9, name: 'Ikan Katombo', image: 'https://i.pinimg.com/1200x/1e/34/22/1e3422eec9ad1012bdf82680146c7a7d.jpg', stock: 1200, unit: 'Kg', threshold: 200, price: 120000, category: 'Perikanan', description: 'Ikan katombo segar dari perairan lokal.', lastUpdate: new Date().toISOString(), koperasiAsal: "Koperasi Ampibabo" },

            // Peternakan
            { id: 7, name: 'Daging Sapi (Has Dalam)', image: 'https://i.pinimg.com/736x/f5/ac/48/f5ac48b03ef022dc0fb2ab255cd1a87a.jpg', stock: 500, unit: 'Kg', threshold: 50, price: 145000, category: 'Peternakan', description: 'Daging sapi tenderloin kualitas premium, untuk katering dan hotel.', lastUpdate: new Date().toISOString(), koperasiAsal: "Koperasi Ampibabo" },
            { id: 8, name: 'Ayam Broiler Utuh', image: 'https://i.pinimg.com/1200x/2d/df/55/2ddf55b2643f0de53f63b1203b281825.jpg', stock: 2500, unit: 'Ekor', threshold: 500, price: 38000, category: 'Peternakan', description: 'Ayam broiler utuh beku, ukuran 0.8-1.0 Kg per ekor.', lastUpdate: new Date().toISOString(), koperasiAsal: "Koperasi Ampibabo" },
            { id: 13, name: 'Telur Ayam Ras', image: 'https://i.pinimg.com/736x/7a/94/80/7a94801c55817b95d81f4963433d72aa.jpg', stock: 50000, unit: 'Butir', threshold: 10000, price: 2200, category: 'Peternakan', description: 'Telur ayam ras segar, pasokan harian.', lastUpdate: new Date().toISOString(), koperasiAsal: "Koperasi Ampibabo" },
        ];
        const INITIAL_CUSTOMERS = [
            // Data pengguna awal telah dihapus
        ];
        const INITIAL_ORDERS = [
            // Data pesanan awal telah dihapus
        ];
        const INITIAL_CATEGORIES = ['Pertanian', 'Perkebunan', 'Perikanan', 'Peternakan'];
        const INITIAL_VOUCHERS = [
            { id: 'v1', code: 'PANENRAYA20K', type: 'fixed', value: 20000 },
            { id: 'v2', code: 'DISKON10', type: 'percentage', value: 10 }
        ];
        const INITIAL_PAYMENT_METHODS = [
            { id: 'cash', name: 'Bayar di Kantor Koperasi', enabled: true, details: { info: 'Silakan lakukan pembayaran langsung di kantor koperasi kami.' } },
            { id: 'transfer', name: 'Transfer Bank', enabled: true, details: { bank: 'Bank Mandiri', account: '123-456-7890', name: 'Koperasi Ampibabo' } },
            { id: 'qris', name: 'QRIS', enabled: false, details: { info: 'Pindai kode QR untuk membayar.', imageUrl: 'https://placehold.co/200x200?text=QRIS' } }
        ];

        const INITIAL_FARMER_OFFERS = [
            { id: 'fo1', farmerName: 'Kelompok Tani Maju', productName: 'Bawang Merah', quantity: 500, unit: 'Kg', price: 25000, harvestDate: '2025-10-15', status: 'Tersedia' },
            { id: 'fo2', farmerName: 'Kelompok Nelayan Pesisir', productName: 'Ikan Tuna', quantity: 200, unit: 'Kg', price: 28000, harvestDate: '2025-10-12', status: 'Tersedia' },
            { id: 'fo3', farmerName: 'Peternakan Unggas Sejahtera', productName: 'Telur Ayam Kampung', quantity: 1000, unit: 'Butir', price: 2500, harvestDate: '2025-10-10', status: 'Terjual' },
        ];
        const INITIAL_STOCK_NEEDS = [
            { id: 'sn1', productName: 'Jagung Pipil Kering', quantity: 5, unit: 'Ton', priceRange: 'Rp 4.000 - Rp 4.500', postDate: '2025-10-01', status: 'Aktif' },
            { id: 'sn2', productName: 'Kelapa Tua', quantity: 2000, unit: 'Butir', priceRange: 'Rp 3.000 - Rp 3.500', postDate: '2025-09-28', status: 'Terpenuhi' },
        ];
        const INITIAL_SCHEDULES = [
            { id: 'sch1', title: 'Tanam Padi - Kel. Tani Maju', start: '2025-10-05', end: '2025-10-10', type: 'tanam', backgroundColor: '#3b82f6' },
            { id: 'sch2', title: 'Panen Jagung - Budi Santoso', start: '2025-10-12', type: 'panen', backgroundColor: '#10b981' },
            { id: 'sch3', title: 'Tanam Cabai - Rina Amelia', start: '2025-10-20', type: 'tanam', backgroundColor: '#3b82f6' },
            { id: 'sch4', title: 'Panen Padi - Kel. Tani Maju', start: '2026-01-15', end: '2026-01-25', type: 'panen', backgroundColor: '#10b981' },
        ];
        const INITIAL_LAND_AREAS = [
            { id: 'la1', farmerName: 'Budi Santoso', landLocation: 'Desa Sukamaju, Blok A', area: 2.5, unit: 'Hektar', commodity: 'Padi', status: 'Aktif' },
            { id: 'la2', farmerName: 'Rina Amelia', landLocation: 'Desa Mulyasari', area: 1, unit: 'Hektar', commodity: 'Cabai dan Tomat', status: 'Aktif' },
            { id: 'la3', farmerName: 'Kelompok Tani Maju', landLocation: 'Hamparan Sawah Irigasi', area: 15, unit: 'Hektar', commodity: 'Padi', status: 'Aktif' },
        ];
        const INITIAL_LOANS = [
            { 
                id: 'LN-1', customerId: 1, customerName: 'Budi Santoso', amount: 5000000, interestRate: 1.5, term: 12, installment: 458333, status: 'Aktif', date: '2025-07-01',
                paymentHistory: [
                    { date: '2025-08-01', amount: 458333 }, { date: '2025-09-01', amount: 458333 }, { date: '2025-10-01', amount: 458333 }
                ]
            },
            { 
                id: 'LN-2', customerId: 2, customerName: 'Rina Amelia', amount: 10000000, interestRate: 1.2, term: 24, installment: 466667, status: 'Lunas', date: '2023-09-15',
                paymentHistory: Array(24).fill(0).map((_, i) => ({ date: new Date(2023, 9 + i, 15).toISOString().split('T')[0], amount: 466667 }))
            },
            { id: 'LN-3', customerId: 3, customerName: 'Citra Lestari', amount: 2000000, interestRate: 2, term: 6, installment: 366667, status: 'Diajukan', date: '2025-09-20', paymentHistory: [] },
        ];

        // Data simulasi untuk pesanan dari Perumda
        const INITIAL_PERUMDA_ORDERS = [
            { id: 'PRD-001', customer: 'Perumda Pangan Jaya', date: '2025-09-28T10:00:00Z', total: 12500000, status: 'Menunggu Verifikasi', items: [{ name: 'Beras IR-64 Premium', quantity: 1, unit: 'Ton', price: 12500000 }] },
            { id: 'PRD-002', customer: 'Perumda Agro Niaga', date: '2025-09-25T14:30:00Z', total: 7500000, status: 'Diproses', items: [{ name: 'Kentang Dieng Super', quantity: 500, unit: 'Kg', price: 15000 }] }
        ];
        
        // Data Admin Eksternal (dipindahkan dari admin_besar_pemda.html)
        const INITIAL_EXTERNAL_USERS = [
            // Data admin eksternal awal telah dihapus
        ];

        // Data dummy untuk riwayat pembelian
        const INITIAL_PURCHASES = [
            { id: 'PUR-1', date: '2025-09-01', supplier: 'Kelompok Tani Maju', productName: 'Gabah Kering Panen', quantity: 5, unit: 'Ton', price: 5200, total: 26000000, koperasiAsal: "Koperasi Ampibabo" },
            { id: 'PUR-2', date: '2025-09-05', supplier: 'Budi Santoso (Petani)', productName: 'Cabai Rawit Merah', quantity: 100, unit: 'Kg', price: 55000, total: 5500000, koperasiAsal: "Koperasi Ampibabo" },
            { id: 'PUR-3', date: '2025-09-10', supplier: 'BUMDes Mulyasari', productName: 'Kelapa Tua', quantity: 2000, unit: 'Butir', price: 3000, total: 6000000, koperasiAsal: "Koperasi Ampibabo" },
        ];

        // --- UTILITY & HELPER FUNCTIONS ---
        const formatRupiah = (number) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);
        
        // Generic DB functions
        const getFromDB = (key) => JSON.parse(localStorage.getItem(key)) || [];
        const saveToDB = (key, data) => localStorage.setItem(key, JSON.stringify(data));

        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alert-container');
            if (!alertContainer) return;

            const alertId = 'alert-' + Date.now();
            const isError = type === 'error';

            const bgColor = isError ? 'bg-rose-500' : 'bg-emerald-500';
            const iconSvg = isError 
                ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>`
                : `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`;

            const alertEl = document.createElement('div');
            alertEl.id = alertId;
            alertEl.className = `flex items-center p-4 mb-4 text-white ${bgColor} rounded-lg shadow-lg transition-all duration-300 transform translate-x-full`;
            alertEl.innerHTML = `
                <div class="flex-shrink-0">${iconSvg}</div>
                <div class="ml-3 text-sm font-medium">${message}</div>
                <button type="button" class="ml-auto -mx-1.5 -my-1.5 bg-white/20 text-white rounded-lg focus:ring-2 focus:ring-white/50 p-1.5 hover:bg-white/30 inline-flex h-8 w-8" onclick="document.getElementById('${alertId}').remove()">
                    <span class="sr-only">Close</span>
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                </button>
            `;

            alertContainer.appendChild(alertEl);

            // Animate in
            requestAnimationFrame(() => alertEl.classList.remove('translate-x-full'));

            // Auto-remove after 5 seconds
            setTimeout(() => alertEl.remove(), 5000);
        }

        function initializeDatabase() {
            if (!localStorage.getItem(DB_PRODUCTS_KEY)) saveToDB(DB_PRODUCTS_KEY, INITIAL_PRODUCTS);
            if (!localStorage.getItem(DB_CUSTOMERS_KEY)) saveToDB(DB_CUSTOMERS_KEY, INITIAL_CUSTOMERS);
            if (!localStorage.getItem(DB_ORDERS_KEY)) saveToDB(DB_ORDERS_KEY, INITIAL_ORDERS);
            if (!localStorage.getItem(DB_CATEGORIES_KEY)) saveToDB(DB_CATEGORIES_KEY, INITIAL_CATEGORIES);
            if (!localStorage.getItem(DB_VOUCHERS_KEY)) saveToDB(DB_VOUCHERS_KEY, INITIAL_VOUCHERS);
            if (!localStorage.getItem(DB_BANNERS_KEY)) saveToDB(DB_BANNERS_KEY, []);
            if (!localStorage.getItem(DB_NOTIFICATIONS_KEY)) saveToDB(DB_NOTIFICATIONS_KEY, []);
            if (!localStorage.getItem(DB_FARMER_OFFERS_KEY)) saveToDB(DB_FARMER_OFFERS_KEY, INITIAL_FARMER_OFFERS);
            if (!localStorage.getItem(DB_STOCK_NEEDS_KEY)) saveToDB(DB_STOCK_NEEDS_KEY, INITIAL_STOCK_NEEDS);
            if (!localStorage.getItem(DB_SCHEDULES_KEY)) saveToDB(DB_SCHEDULES_KEY, INITIAL_SCHEDULES);
            if (!localStorage.getItem(DB_LAND_AREAS_KEY)) saveToDB(DB_LAND_AREAS_KEY, INITIAL_LAND_AREAS);
            if (!localStorage.getItem(DB_LOANS_KEY)) saveToDB(DB_LOANS_KEY, INITIAL_LOANS);
            if (!localStorage.getItem(DB_PURCHASES_KEY)) saveToDB(DB_PURCHASES_KEY, INITIAL_PURCHASES); // Inisialisasi data pembelian
            if (!localStorage.getItem(DB_PERUMDA_ORDERS_KEY)) saveToDB(DB_PERUMDA_ORDERS_KEY, INITIAL_PERUMDA_ORDERS); // Inisialisasi data Perumda
            if (!localStorage.getItem(DB_PAYMENT_METHODS_KEY)) saveToDB(DB_PAYMENT_METHODS_KEY, INITIAL_PAYMENT_METHODS);
            if (!localStorage.getItem(DB_EXTERNAL_USERS_KEY)) saveToDB(DB_EXTERNAL_USERS_KEY, INITIAL_EXTERNAL_USERS); // Inisialisasi data admin eksternal
            if (!localStorage.getItem(DB_REQUESTS_KEY)) saveToDB(DB_REQUESTS_KEY, []); // Inisialisasi data permintaan
        }

        function renderPerumdaOrdersTable() {
            // Kunci ini harus sama dengan yang digunakan di Perumda_dashboard.html
            const perumdaOrders = getFromDB(DB_PERUMDA_ORDERS_KEY) || []; 
            const tableBody = document.getElementById('perumda-orders-table').querySelector('tbody');
            tableBody.innerHTML = '';

            if (perumdaOrders.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-4">Belum ada pesanan dari Perumda.</td></tr>';
                return;
            }

            perumdaOrders.forEach(order => {
                const statusClasses = {
                    'Menunggu Verifikasi': 'bg-orange-100 text-orange-800',
                    'Diproses': 'bg-blue-100 text-blue-800',
                    'Selesai': 'bg-emerald-100 text-emerald-800',
                };
                const statusClass = statusClasses[order.status] || 'bg-slate-100 text-slate-800';
                const row = `
                    <tr data-id="${order.id}">
                        <td data-label="ID Transaksi" class="p-3 font-mono text-sm">${order.id}</td>
                        <td data-label="Pelanggan" class="p-3 font-medium">${order.customer}</td>
                        <td data-label="Tanggal" class="p-3">${new Date(order.date).toLocaleDateString('id-ID')}</td>
                        <td data-label="Total" class="p-3">${formatRupiah(order.total)}</td>
                        <td data-label="Status" class="p-3"><span class="text-xs font-medium px-2.5 py-0.5 rounded-full ${statusClass}">${order.status}</span></td>
                        <td data-label="Aksi" class="p-3 actions-cell">
                            <button onclick="openPerumdaOrderDetailModal('${order.id}')" class="text-blue-600 hover:text-blue-900">Lihat Detail</button>
                        </td>
                    </tr>`;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
            const sidebar = document.getElementById('sidebar');
            const menuBtn = document.getElementById('menu-btn');
            const sidebarNav = document.getElementById('sidebar-nav');
            const headerTitle = document.getElementById('header-title');
            const pageContents = document.querySelectorAll('.page-content');
            
            // --- CORE FUNCTIONALITY & STATE ---
            let salesChart; // To hold the chart instance
            let itemToDelete = { element: null, type: null, id: null };

            // Admin Settings Modal
            document.getElementById('admin-settings-btn').addEventListener('click', (e) => {
                e.preventDefault();
                openModal(document.getElementById('admin-settings-modal'));
                // Populate current admin name
                document.getElementById('current-admin-name').value = window.loggedInAdminName;
                // Close profile dropdown
                profileDropdown.classList.add('hidden', 'opacity-0', 'scale-95');
            });

            document.getElementById('change-admin-name-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const newName = document.getElementById('new-admin-name').value.trim();
                if (newName) {
                    // In a real app, you'd save this to the server.
                    // Here, we'll update the session and local storage simulation.
                    let admins = getFromDB('gerbangPanganAdmins'); // Assuming you have an admin DB
                    const admin = admins.find(a => a.username === window.loggedInAdminName);
                    if (admin) {
                        admin.username = newName;
                        saveToDB('gerbangPanganAdmins', admins);
                    }
                    
                    sessionStorage.setItem('loggedInAdminName', newName);
                    window.loggedInAdminName = newName;
                    
                    // Update UI
                    document.getElementById('sidebar-admin-name').textContent = `oleh ${newName}`;
                    updateAdminAvatar(newName);
                    
                    showAlert(`Nama admin berhasil diubah menjadi "${newName}".`);
                    closeModal(document.getElementById('admin-settings-modal'));
                }
            });

            document.getElementById('change-admin-password-form').addEventListener('submit', (e) => {
                e.preventDefault();
                // This is a simulation. In a real app, never handle passwords like this on the client-side.
                const currentPassword = document.getElementById('current-admin-password').value;
                const newPassword = document.getElementById('new-admin-password').value;
                const confirmPassword = document.getElementById('confirm-admin-password').value;

                if (newPassword !== confirmPassword) {
                    showAlert('Kata sandi baru tidak cocok.', 'error');
                    return;
                }
                
                // Simulate checking old password and updating
                showAlert('Kata sandi berhasil diubah (simulasi).');
                e.target.reset();
                closeModal(document.getElementById('admin-settings-modal'));
            });

            function showPage(targetPageId = 'page-dasbor') {
                // 1. Sembunyikan semua konten halaman
                pageContents.forEach(page => {
                    page.classList.add('hidden');
                });

                // 2. Tampilkan hanya konten yang dituju
                const targetPage = document.getElementById(targetPageId);
                if (targetPage) {
                    targetPage.classList.remove('hidden');
                }

                // 3. Atur status aktif pada link sidebar
                document.querySelectorAll('#sidebar-nav .sidebar-link').forEach(link => {
                    link.classList.remove('sidebar-link-active');
                });
                const activeLink = document.querySelector(`#sidebar-nav .sidebar-link[data-target="${targetPageId}"]`);
                if (activeLink) {
                    activeLink.classList.add('sidebar-link-active');
                    // 4. Perbarui judul di header
                    headerTitle.textContent = activeLink.textContent.trim();
                }

                // 5. Perbarui notifikasi badge di sidebar
                updateSidebarBadges();

                // 6. Tutup sidebar secara otomatis di tampilan mobile setelah link diklik
                if (window.innerWidth < 768) {
                    sidebar.classList.add('-translate-x-full');
                }

                // 7. Panggil fungsi render yang sesuai untuk halaman yang baru ditampilkan
                const renderActions = {
                    'page-dasbor': renderDashboardMetrics,
                    'page-produk': renderProductsTable,
                    'page-pelanggan': renderCustomersTable,
                    'page-ulasan': renderReviewsTable,
                    'page-permintaan': renderRequestsTable,
                    'page-kategori': renderCategoriesTable,
                    'page-pesanan': renderOrdersTable,
                    'page-stok-gudang': renderStokGudangTable,
                    'page-simpanan': () => { renderSavingsTable(); updateSavingsMemberDropdown(); },
                    'page-info-penawaran': renderFarmerOffersTable,
                    'page-kebutuhan-stok': renderStockNeedsTable,
                    'page-jadwal-tanam': renderPlantingCalendar,
                    'page-jadwal-panen': renderHarvestingCalendar,
                    'page-luas-lahan': renderLandAreaTable,
                    'page-perumda': renderPerumdaOrdersTable,
                    'page-pinjaman': renderLoansTable,
                    'page-pembelian': renderPurchasesTable,
                    'page-laporan': () => createSalesChart('salesChartLaporan'),
                };

                renderActions[targetPageId]?.();
            }
            
            // --- EVENT LISTENERS ---

            // Sidebar Toggle (Mobile)
            menuBtn.addEventListener('click', () => sidebar.classList.toggle('-translate-x-full'));

            // Logout Button
            document.querySelectorAll('#logout-btn, #logout-btn-dropdown').forEach(btn => btn.addEventListener('click', (e) => {
                e.preventDefault(); 
                sessionStorage.clear(); // Membersihkan semua sesi terkait admin
                window.location.href = 'admin_apk_login.html';
            }));

            // --- PERBAIKAN LOGIKA NAVIGASI SPA ---
            sidebarNav.addEventListener('click', (e) => { const link = e.target.closest('.sidebar-link'); if (link) { e.preventDefault(); window.location.hash = link.dataset.target; } });
            window.addEventListener('hashchange', () => showPage(window.location.hash.substring(1)));

            const profileBtn = document.getElementById('profile-btn');
            const profileDropdown = document.getElementById('profile-dropdown');
            const notifBtn = document.getElementById('notif-btn');
            const notifDropdown = document.getElementById('notif-dropdown');

            profileBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                profileDropdown.classList.toggle('hidden');
                profileDropdown.classList.toggle('opacity-0');
                profileDropdown.classList.toggle('scale-95');
                notifDropdown.classList.add('hidden', 'opacity-0', 'scale-95');
            });

            notifBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                notifDropdown.classList.toggle('hidden');
                notifDropdown.classList.toggle('opacity-0');
                notifDropdown.classList.toggle('scale-95');
                profileDropdown.classList.add('hidden', 'opacity-0', 'scale-95');
            });

            window.addEventListener('click', (e) => {
                if (!profileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
                    profileDropdown.classList.add('hidden', 'opacity-0', 'scale-95');
                }
                if (!notifBtn.contains(e.target) && !notifDropdown.contains(e.target)) {
                    notifDropdown.classList.add('hidden', 'opacity-0', 'scale-95');
                }
            });

            // Product page listeners
            document.getElementById('product-search').addEventListener('input', renderProductsTable);
            document.getElementById('category-filter').addEventListener('change', renderProductsTable);

            // --- PERBAIKAN KRUSIAL (v2): Pindahkan event listener gambar ke sini ---
            // Ini memastikan listener siap sejak halaman dimuat, bukan saat tombol simpan ditekan.
            document.getElementById('product-image-upload')?.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        // Simpan data Base64 ke input tersembunyi
                        document.getElementById('product-image-base64').value = e.target.result;
                        // Tampilkan preview gambar
                        document.getElementById('product-image-preview').innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover rounded-lg">`;
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Order page listeners
            document.getElementById('order-search').addEventListener('input', renderOrdersTable);
            document.getElementById('status-filter').addEventListener('change', renderOrdersTable);

            // Customer page listeners
            document.getElementById('customer-search').addEventListener('input', renderCustomersTable);

            // Savings page listeners
            document.getElementById('savings-search').addEventListener('input', renderSavingsTable);

            // Stok Gudang page listeners
            document.getElementById('stok-search').addEventListener('input', renderStokGudangTable);
            document.getElementById('stok-status-filter').addEventListener('change', renderStokGudangTable);

            // Reviews page listeners
            document.getElementById('review-search').addEventListener('input', renderReviewsTable);
            document.getElementById('rating-filter').addEventListener('change', renderReviewsTable);

            // --- MODAL & FORM HANDLING ---

            function openModal(modal) {
                if (!modal) return;
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    modal.querySelector('.modal-content').classList.remove('scale-95');
                }, 10);
            }

            function closeModal(modal) {
                if (!modal) return;
                modal.classList.add('opacity-0');
                modal.querySelector('.modal-content').classList.add('scale-95');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }

            // Attach close listeners to all close buttons and cancel buttons
            document.querySelectorAll('.close-modal-btn, .cancel-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const modal = btn.closest('.modal-container');
                    if (modal) closeModal(modal);
                });
            });
            
            // Close modal when clicking on the backdrop
            document.querySelectorAll('.modal-container').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal(modal);
                    }
                });
            });

            // Product Modal
            document.getElementById('add-product-btn').addEventListener('click', () => openProductModal());
            document.getElementById('save-product-btn').addEventListener('click', saveProduct);
            document.getElementById('products-table').addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-product-btn');
                const deleteBtn = e.target.closest('.delete-item-btn');
                if (editBtn) {
                    const row = editBtn.closest('tr');
                    const productId = parseInt(row.dataset.id);
                    openProductModal(productId);
                }
                if (deleteBtn) {
                    const row = deleteBtn.closest('tr');
                    const productId = parseInt(row.dataset.id);
                    const products = getFromDB(DB_PRODUCTS_KEY);
                    const product = products.find(p => p.id === productId);
                    itemToDelete = { type: 'product', id: productId, name: product.name };
                    openDeleteModal(`Anda yakin ingin menghapus produk "${product.name}"?`);
                }
            });

            // Customer Modal
            document.getElementById('add-customer-btn').addEventListener('click', () => openCustomerModal());
            document.getElementById('save-customer-btn').addEventListener('click', saveCustomer);
            document.getElementById('customers-table').addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-customer-btn');
                const deleteBtn = e.target.closest('.delete-item-btn');
                if (editBtn) {
                    const row = editBtn.closest('tr');
                    const customerId = parseInt(row.dataset.id);
                    openCustomerModal(customerId);
                }
                if (deleteBtn) {
                    const row = deleteBtn.closest('tr');
                    const customerId = parseInt(row.dataset.id);
                    const customers = getFromDB(DB_CUSTOMERS_KEY);
                    const customer = customers.find(c => c.id === customerId);
                    itemToDelete = { type: 'customer', id: customerId, name: customer.name };
                    openDeleteModal(`Anda yakin ingin menghapus anggota "${customer.name}"?`);
                }
            });

            // Category Modal
            document.getElementById('add-category-btn').addEventListener('click', () => openCategoryModal());
            document.getElementById('save-category-btn').addEventListener('click', saveCategory);
            // Event listener untuk tabel kategori dinonaktifkan karena tabelnya sudah dihapus.
            // document.getElementById('categories-table').addEventListener('click', (e) => { ... });

            // Order Detail Modal
            document.querySelector('main').addEventListener('click', (e) => {
                const detailBtn = e.target.closest('.view-order-btn');
                const perumdaDetailBtn = e.target.closest('#perumda-orders-table button');

                if (detailBtn) {
                    const orderId = detailBtn.closest('tr').dataset.id;
                    openOrderDetailModal(orderId, 'regular');
                } else if (perumdaDetailBtn && perumdaDetailBtn.textContent.includes('Lihat Detail')) {
                    const orderId = perumdaDetailBtn.closest('tr').dataset.id;
                    openOrderDetailModal(orderId, 'perumda');
                }
            });

            // Delete Confirmation
            document.getElementById('confirm-delete-btn').addEventListener('click', confirmDelete);

            // Notification Form
            document.getElementById('notification-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const title = document.getElementById('notif-title').value;
                const detail = document.getElementById('notif-detail').value;
                const icon = document.getElementById('notif-icon').value;
                
                let notifications = getFromDB(DB_NOTIFICATIONS_KEY);
                const newNotif = {
                    id: 'notif-' + Date.now(),
                    title: title,
                    detail: detail,
                    icon: icon,
                    date: new Date().toISOString(),
                    read: false,
                    type: 'broadcast'
                };
                notifications.push(newNotif);
                saveToDB(DB_NOTIFICATIONS_KEY, notifications);
                
                showAlert('Notifikasi berhasil dikirim ke semua pengguna.');
                document.getElementById('notification-form').reset();
            });

            // Savings Modal
            document.getElementById('add-savings-btn').addEventListener('click', () => {
                openModal(document.getElementById('savings-transaction-modal'));
            });
            document.getElementById('process-savings-btn').addEventListener('click', processSavingsTransaction);

            // Banner Upload
            document.getElementById('banner-upload').addEventListener('change', handleBannerUpload);
            document.getElementById('banner-table').addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-item-btn');
                if (deleteBtn) {
                    const row = deleteBtn.closest('tr');
                    const bannerId = row.dataset.id;
                    const banners = getFromDB(DB_BANNERS_KEY);
                    const banner = banners.find(b => b.id == bannerId);
                    itemToDelete = { type: 'banner', id: bannerId, name: banner.name };
                    openDeleteModal(`Anda yakin ingin menghapus banner "${banner.name}"?`);
                }
            });

            // Voucher Modal
            document.getElementById('add-voucher-btn').addEventListener('click', () => {
                openModal(document.getElementById('add-voucher-modal'));
            });

            document.getElementById('save-voucher-btn').addEventListener('click', saveVoucher);
            document.getElementById('vouchers-table').addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-item-btn');
                if (deleteBtn) {
                    const row = deleteBtn.closest('tr');
                    const voucherId = row.dataset.id;
                    const vouchers = getFromDB(DB_VOUCHERS_KEY);
                    const voucher = vouchers.find(v => v.id === voucherId);
                    itemToDelete = { type: 'voucher', id: voucherId, name: voucher.code };
                    openDeleteModal(`Anda yakin ingin menghapus voucher "${voucher.code}"?`);
                }
            });

            // Reply Modal
            document.getElementById('send-reply-btn').addEventListener('click', sendReply);

            function openReplyModal(requestId) {
                const requests = getFromDB(DB_REQUESTS_KEY);
                const request = requests.find(r => r.id == requestId);
                if (!request) return;

                document.getElementById('reply-request-id').value = requestId;
                document.getElementById('original-request-text').textContent = request.request;
                document.getElementById('reply-details').value = request.reply || ''; // Tampilkan balasan lama jika ada
                openModal(document.getElementById('reply-request-modal'));
            }

            function sendReply() {
                const requestId = document.getElementById('reply-request-id').value;
                const replyText = document.getElementById('reply-details').value;
                let requests = getFromDB(DB_REQUESTS_KEY);
                const index = requests.findIndex(r => r.id == requestId);
                if (index > -1) {
                    requests[index].status = 'Dibalas';
                    requests[index].reply = replyText;
                    requests[index].replyDate = new Date().toISOString();
                    saveToDB(DB_REQUESTS_KEY, requests);
                    showAlert('Balasan berhasil dikirim.');
                    renderRequestsTable();
                    closeModal(document.getElementById('reply-request-modal'));
                }
            }

            function markRequestAsRead(requestId) {
                let requests = getFromDB(DB_REQUESTS_KEY);
                const index = requests.findIndex(r => r.id == requestId);
                if (index > -1) { requests[index].status = 'Dibaca'; saveToDB(DB_REQUESTS_KEY, requests); renderRequestsTable(); updateSidebarBadges(); }
            }

            // Loan Modal
            document.getElementById('add-loan-btn')?.addEventListener('click', () => openLoanModal());
            document.getElementById('save-loan-btn')?.addEventListener('click', saveLoan);
            document.getElementById('loans-table-body')?.addEventListener('click', handleLoanTableActions);

            // Purchase Modal
            document.getElementById('add-purchase-btn')?.addEventListener('click', () => openModal(document.getElementById('purchase-modal')));
            document.getElementById('save-purchase-btn')?.addEventListener('click', savePurchase);

            // Purchase page filters (Riwayat Pembelian)
            const purchaseFilters = ['purchase-search', 'purchase-start-date', 'purchase-end-date'];
            purchaseFilters.forEach(id => {
                document.getElementById(id)?.addEventListener('input', renderPurchasesTable);
            });

            // Stock Need Form
            document.getElementById('post-stock-need-form')?.addEventListener('submit', (e) => {
                e.preventDefault();
                let needs = getFromDB(DB_STOCK_NEEDS_KEY);
                const newNeed = {
                    id: 'sn' + Date.now(),
                    productName: document.getElementById('need-product-name').value,
                    quantity: document.getElementById('need-quantity').value,
                    unit: document.getElementById('need-unit').value,
                    priceRange: document.getElementById('need-price-range').value,
                    postDate: new Date().toISOString().split('T')[0],
                    status: 'Aktif'
                };
                needs.unshift(newNeed);
                saveToDB(DB_STOCK_NEEDS_KEY, needs);
                showAlert('Kebutuhan stok berhasil diposting.');
                renderStockNeedsTable();
                e.target.reset();
            });
            document.getElementById('stock-needs-table-body')?.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-item-btn');
                if (deleteBtn) {
                    const row = deleteBtn.closest('tr');
                    const needId = row.dataset.id;
                    const needs = getFromDB(DB_STOCK_NEEDS_KEY);
                    const need = needs.find(n => n.id === needId);
                    itemToDelete = { type: 'stockNeed', id: needId, name: `kebutuhan ${need.productName}` };
                    openDeleteModal(`Anda yakin ingin menghapus ${itemToDelete.name}?`);
                }
            });



            // --- RENDER FUNCTIONS (Many were missing) ---
            function renderCustomersTable() {
                const allCustomers = getFromDB(DB_CUSTOMERS_KEY);
                if (!document.getElementById('customers-table')) return;
                const tableBody = document.getElementById('customers-table').querySelector('tbody');
                tableBody.innerHTML = '';
                const searchTerm = document.getElementById('customer-search').value.toLowerCase();
                const customers = allCustomers.filter(c => c.koperasiAsal === window.loggedInKoperasi);

                const filteredCustomers = customers.filter(c => 
                    c.name.toLowerCase().includes(searchTerm) || c.email.toLowerCase().includes(searchTerm)
                );

                if (filteredCustomers.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center p-4">Anggota tidak ditemukan.</td></tr>';
                    return;
                }

                filteredCustomers.forEach(customer => {
                    const statusClass = customer.status === 'Aktif' ? 'bg-emerald-100 text-emerald-800' : 'bg-rose-100 text-rose-800';
                    const row = `
                        <tr data-id="${customer.id}">
                            <td data-label="Anggota" class="p-3 font-medium">${customer.name}</td>
                            <td data-label="Email" class="p-3">${customer.email}</td>
                            <td data-label="Bergabung" class="p-3">${new Date(customer.joinDate).toLocaleDateString('id-ID')}</td>
                            <td data-label="Status" class="p-3"><span class="text-xs font-medium px-2.5 py-0.5 rounded-full ${statusClass}">${customer.status}</span></td>
                            <td data-label="Aksi" class="p-3 actions-cell space-x-2">
                                <button class="edit-customer-btn p-2 bg-slate-100 rounded-md hover:bg-slate-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-600" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                                <button class="delete-item-btn p-2 bg-slate-100 rounded-md hover:bg-rose-100"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-rose-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>
                            </td>
                        </tr>
                    `;
                    tableBody.insertAdjacentHTML('beforeend', row);
                });
            }

            function renderOrdersTable() {
                const allOrders = getFromDB(DB_ORDERS_KEY);
                const allProducts = getFromDB(DB_PRODUCTS_KEY);
                if (!document.getElementById('orders-table')) return;
                const tableBody = document.getElementById('orders-table').querySelector('tbody');
                tableBody.innerHTML = '';
                const searchTerm = document.getElementById('order-search').value.toLowerCase();
                const statusFilter = document.getElementById('status-filter').value;

                const koperasiProducts = allProducts.filter(p => p.koperasiAsal === window.loggedInKoperasi).map(p => p.name);
                const orders = allOrders.filter(o => o.items.some(item => koperasiProducts.includes(item.name)));


                const filteredOrders = orders.filter(o => {
                    const matchesSearch = o.id.toLowerCase().includes(searchTerm) || o.customerName.toLowerCase().includes(searchTerm);
                    const matchesStatus = statusFilter ? o.status === statusFilter : true;
                    return matchesSearch && matchesStatus;
                }).sort((a, b) => new Date(b.date) - new Date(a.date));

                if (filteredOrders.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-4">Pesanan tidak ditemukan.</td></tr>';
                    return;
                }

                filteredOrders.forEach(order => {
                    const coopTotalPrice = order.items.reduce((sum, item) => {
                        if (koperasiProducts.includes(item.name)) {
                            return sum + (item.price * item.quantity);
                        }
                        return sum;
                    }, 0);

                    const statusClasses = {
                        'Menunggu Pembayaran': 'bg-yellow-100 text-yellow-800',
                        'Menunggu Pembayaran Tunai': 'bg-orange-100 text-orange-800',
                        'Diproses': 'bg-blue-100 text-blue-800', 'Menunggu Verifikasi': 'bg-orange-100 text-orange-800',
                        'Dikirim': 'bg-cyan-100 text-cyan-800',
                        'Selesai': 'bg-emerald-100 text-emerald-800',
                        'Dibatalkan': 'bg-rose-100 text-rose-800',
                        'Menunggu Verifikasi': 'bg-orange-100 text-orange-800',
                    };
                    const statusClass = statusClasses[order.status] || 'bg-slate-100 text-slate-800';
                    const row = `
                        <tr data-id="${order.id}">
                            <td data-label="ID Pesanan" class="p-3 font-mono text-sm">${order.id}</td>
                            <td data-label="Pelanggan" class="p-3">${order.customerName}</td>
                            <td data-label="Tanggal" class="p-3">${new Date(order.date).toLocaleDateString('id-ID')}</td>
                            <td data-label="Total" class="p-3">${formatRupiah(coopTotalPrice)}</td>
                            <td data-label="Status" class="p-3"><span class="text-xs font-medium px-2.5 py-0.5 rounded-full ${statusClass}">${order.status}</span></td>
                            <td data-label="Aksi" class="p-3 actions-cell">
                                <button class="view-order-btn text-blue-600 hover:text-blue-900">Lihat Detail</button>
                            </td>
                        </tr>
                    `;
                    tableBody.insertAdjacentHTML('beforeend', row);
                });
            }

            function renderReviewsTable() {
                const allOrders = getFromDB(DB_ORDERS_KEY);
                const allProducts = getFromDB(DB_PRODUCTS_KEY);
                if (!document.getElementById('reviews-table')) return;
                const tableBody = document.getElementById('reviews-table').querySelector('tbody');
                tableBody.innerHTML = '';
                const searchTerm = document.getElementById('review-search').value.toLowerCase();
                const ratingFilter = parseInt(document.getElementById('rating-filter').value);
                
                const koperasiProducts = allProducts.filter(p => p.koperasiAsal === window.loggedInKoperasi).map(p => p.name);
                const orders = allOrders.filter(o => o.items.some(item => koperasiProducts.includes(item.name)));

                const filteredReviews = orders.filter(o => {
                    const hasReview = o.rating > 0;
                    // --- PERBAIKAN: Pencarian ulasan kini hanya mencakup produk dari koperasi yang relevan ---
                    const matchesSearch = o.customerName.toLowerCase().includes(searchTerm) || 
                                          o.items.some(i => koperasiProducts.includes(i.name) && i.name.toLowerCase().includes(searchTerm));
                    const matchesRating = !ratingFilter || o.rating === ratingFilter;
                    return hasReview && matchesSearch && matchesRating;
                });

                if (filteredReviews.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center p-4">Belum ada ulasan.</td></tr>';
                    return;
                }
                filteredReviews.forEach(order => {
                    const stars = '⭐'.repeat(order.rating) + '☆'.repeat(5 - order.rating); // Using ⭐ and ☆ for better compatibility
                    const row = `
                        <tr data-id="${order.id}">
                            <td data-label="Produk" class="p-3 font-medium">${order.items.filter(i => koperasiProducts.includes(i.name)).map(i => i.name).join(', ')}</td>
                            <td data-label="Pelanggan" class="p-3">${order.customerName}</td>
                            <td data-label="Rating" class="p-3 text-amber-500">${stars}</td>
                            <td data-label="Ulasan" class="p-3 italic text-slate-600">"${order.comment || '-'}"</td>
                            <td data-label="Aksi" class="p-3 actions-cell">
                                <button class="delete-item-btn p-2 bg-slate-100 rounded-md hover:bg-rose-100" title="Hapus Ulasan">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-rose-600" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </td>
                        </tr>
                    `;
                    tableBody.insertAdjacentHTML('beforeend', row);
                });
            }

            document.getElementById('reviews-table')?.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-item-btn');
                if (deleteBtn) {
                    const row = deleteBtn.closest('tr');
                    const orderId = row.dataset.id;
                    const orders = getFromDB(DB_ORDERS_KEY);
                    const order = orders.find(o => o.id === orderId);
                    itemToDelete = { type: 'review', id: orderId, name: `ulasan untuk pesanan #${orderId}` };
                    openDeleteModal(`Anda yakin ingin menghapus ${itemToDelete.name}? Ini akan mereset rating dan komentar pesanan.`);
                }
            });

            function renderCategoriesTable() {
                const categories = getFromDB(DB_CATEGORIES_KEY);
                const products = getFromDB(DB_PRODUCTS_KEY);
                if (!document.getElementById('categories-table')) return;
                const tableBody = document.getElementById('categories-table').querySelector('tbody');
                tableBody.innerHTML = '';
                if (categories.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="3" class="text-center p-4">Belum ada kategori.</td></tr>';
                    return;
                }
                categories.forEach(cat => {
                    const productCount = products.filter(p => p.category === cat).length;
                    const row = `<tr>
                                     <td data-label="Nama Kategori" class="p-3 font-medium">${cat}</td>
                                     <td data-label="Jumlah Produk" class="p-3">${productCount} produk</td>
                                 </tr>`;
                    tableBody.insertAdjacentHTML('beforeend', row);
                });
            }

            function renderRequestsTable() {
                const requests = getFromDB(DB_REQUESTS_KEY);
                const tableBody = document.getElementById('requests-table')?.querySelector('tbody');
                if (!tableBody) return;

                tableBody.innerHTML = '';
                if (requests.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center p-4">Tidak ada permintaan baru.</td></tr>';
                    return;
                }

                requests.forEach(req => {
                    const statusClasses = {
                        'Baru': 'bg-sky-100 text-sky-800',
                        'Dibaca': 'bg-slate-100 text-slate-800',
                        'Dibalas': 'bg-emerald-100 text-emerald-800'
                    };
                    const statusClass = statusClasses[req.status] || 'bg-slate-100 text-slate-800';
                    const row = `
                        <tr data-id="${req.id}">
                            <td data-label="Tanggal" class="p-3">${new Date(req.date).toLocaleString('id-ID')}</td>
                            <td data-label="Pengguna" class="p-3 font-medium">${req.user}</td>
                            <td data-label="Isi Permintaan" class="p-3 text-slate-600">${req.request}</td>
                            <td data-label="Status" class="p-3"><span class="text-xs font-medium px-2.5 py-0.5 rounded-full ${statusClass}">${req.status}</span></td>
                            <td data-label="Aksi" class="p-3 actions-cell space-x-2">
                                <button data-id="${req.id}" class="reply-request-btn text-emerald-600 hover:text-emerald-900 text-sm font-semibold">Balas</button>
                                ${req.status === 'Baru' ? `<button data-id="${req.id}" class="mark-request-read-btn text-blue-600 hover:text-blue-900 text-sm">Tandai Dibaca</button>` : ''}
                            </td>
                        </tr>
                    `;
                    tableBody.insertAdjacentHTML('beforeend', row);
                });

                document.querySelectorAll('.mark-request-read-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        markRequestAsRead(e.currentTarget.dataset.id);
                    });
                });

                document.querySelectorAll('.reply-request-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => openReplyModal(e.currentTarget.dataset.id));
                });
            }

            function renderStokGudangTable() {
                const allProducts = getFromDB(DB_PRODUCTS_KEY);
                const tableBody = document.getElementById('stok-gudang-table-body');
                if (!tableBody) return;
                tableBody.innerHTML = '';
                const searchTerm = document.getElementById('stok-search')?.value.toLowerCase() || '';
                const statusFilter = document.getElementById('stok-status-filter')?.value || '';
                
                const products = allProducts.filter(p => p.koperasiAsal === window.loggedInKoperasi);

                const getStatus = (p) => {
                    if (p.stock <= 0) return 'Habis';
                    if (p.stock < p.threshold) return 'Menipis';
                    return 'Aman';
                };

                const filteredProducts = products.filter(p => {
                    const matchesSearch = p.name.toLowerCase().includes(searchTerm);
                    const matchesStatus = !statusFilter || getStatus(p) === statusFilter;
                    return matchesSearch && matchesStatus;
                }).sort((a, b) => a.stock - b.stock);

                if (filteredProducts.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center p-4">Belum ada produk.</td></tr>';
                    return;
                }
                filteredProducts.forEach(product => {
                    const status = getStatus(product);
                    const statusClasses = {
                        'Habis': 'bg-rose-100 text-rose-800',
                        'Menipis': 'bg-yellow-100 text-yellow-800',
                        'Aman': 'bg-emerald-100 text-emerald-800'
                    };
                    const stockStatus = `<span class="${statusClasses[status]} text-xs font-medium px-2.5 py-0.5 rounded-full">${status}</span>`;
                    const row = `
                        <tr>
                            <td class="p-3 font-medium">${product.name}</td>
                            <td class="p-3">${product.category}</td>
                            <td class="p-3 text-right font-semibold">${product.stock} ${product.unit}</td>
                            <td class="p-3 text-center">${stockStatus}</td>
                            <td class="p-3 text-sm text-slate-500">${new Date(product.lastUpdate).toLocaleString('id-ID')}</td>
                        </tr>
                    `;
                    tableBody.insertAdjacentHTML('beforeend', row);
                });
            }

            function renderBannerTable() {
                const banners = getFromDB(DB_BANNERS_KEY);
                if (!document.getElementById('banner-table')) return;
                const tableBody = document.getElementById('banner-table').querySelector('tbody');
                tableBody.innerHTML = '';
                if (banners.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="3" class="text-center p-4">Belum ada banner.</td></tr>';
                    return;
                }
                banners.forEach(banner => {
                    const row = `
                        <tr data-id="${banner.id}" data-type="banner" data-name="${banner.name}">
                            <td data-label="Preview" class="p-3"><img src="${banner.image}" alt="${banner.name}" class="w-32 h-auto rounded-md object-cover"></td>
                            <td data-label="Nama File" class="p-3">${banner.name}</td>
                            <td data-label="Aksi" class="p-3 actions-cell">
                                <button class="delete-item-btn p-2 bg-slate-100 rounded-md hover:bg-rose-100" title="Hapus Banner"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-rose-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>
                            </td>
                        </tr>
                    `;
                    tableBody.insertAdjacentHTML('beforeend', row);
                });
            }

            function renderVouchersTable() {
                const vouchers = getFromDB(DB_VOUCHERS_KEY);
                if (!document.getElementById('vouchers-table')) return;
                const tableBody = document.getElementById('vouchers-table').querySelector('tbody');
                tableBody.innerHTML = '';
                if (vouchers.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="text-center p-4">Belum ada voucher.</td></tr>';
                    return;
                }
                vouchers.forEach(voucher => {
                    const valueText = voucher.type === 'percentage' ? `${voucher.value}%` : formatRupiah(voucher.value);
                    const row = `
                        <tr data-id="${voucher.id}" data-type="voucher" data-name="${voucher.code}">
                            <td data-label="Kode" class="p-3 font-mono">${voucher.code}</td>
                            <td data-label="Jenis" class="p-3 capitalize">${voucher.type}</td>
                            <td data-label="Nilai" class="p-3">${valueText}</td>
                            <td data-label="Aksi" class="p-3 actions-cell">
                                <button class="delete-item-btn p-2 bg-slate-100 rounded-md hover:bg-rose-100" title="Hapus Voucher"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-rose-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>
                            </td>
                        </tr>
                    `;
                    tableBody.insertAdjacentHTML('beforeend', row);
                });
            }

            function renderFarmerOffersTable() {
                const allOffers = getFromDB(DB_FARMER_OFFERS_KEY);
                const tableBody = document.getElementById('farmer-offers-table-body');
                if (!tableBody) return;
                tableBody.innerHTML = '';
                // Asumsi penawaran petani tidak terikat koperasi spesifik, jadi tampilkan semua
                const offers = allOffers; 

                if (offers.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-4">Belum ada penawaran dari petani.</td></tr>';
                    return;
                }
                offers.forEach(offer => {
                    const statusClass = offer.status === 'Tersedia' ? 'bg-emerald-100 text-emerald-800' : 'bg-slate-100 text-slate-800';
                    const row = `
                        <tr data-id="${offer.id}">
                            <td data-label="Petani" class="p-3 font-medium">${offer.farmerName}</td>
                            <td data-label="Produk" class="p-3">${offer.productName}</td>
                            <td data-label="Jumlah" class="p-3">${offer.quantity} ${offer.unit}</td>
                            <td data-label="Harga" class="p-3">${formatRupiah(offer.price)} / ${offer.unit}</td>
                            <td data-label="Tgl Panen" class="p-3">${new Date(offer.harvestDate).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' })}</td>
                            <td data-label="Status" class="p-3"><span class="text-xs font-medium px-2.5 py-0.5 rounded-full ${statusClass}">${offer.status}</span></td>
                            <td data-label="Aksi" class="p-3 actions-cell space-x-2">
                                <button class="text-blue-600 hover:text-blue-900 text-sm font-semibold">Terima</button>
                                <button class="delete-item-btn p-2 bg-slate-100 rounded-md hover:bg-rose-100" title="Hapus Penawaran">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-rose-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                                </button>
                            </td>
                        </tr>
                    `;
                    tableBody.insertAdjacentHTML('beforeend', row);
                });
            }

            function renderStockNeedsTable() {
                const allNeeds = getFromDB(DB_STOCK_NEEDS_KEY);
                const tableBody = document.getElementById('stock-needs-table-body');
                if (!tableBody) return;
                tableBody.innerHTML = '';
                // Asumsi kebutuhan stok adalah untuk koperasi ini, bisa disesuaikan jika global
                const needs = allNeeds;

                if (needs.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center p-4">Tidak ada kebutuhan stok yang aktif.</td></tr>';
                    return;
                }
                needs.forEach(need => {
                    const statusClass = need.status === 'Aktif' ? 'bg-blue-100 text-blue-800' : 'bg-emerald-100 text-emerald-800';
                    const row = `
                        <tr data-id="${need.id}">
                            <td data-label="Produk" class="p-3 font-medium">${need.productName}</td>
                            <td data-label="Jumlah" class="p-3 text-right">${need.quantity} ${need.unit}</td>
                            <td data-label="Rentang Harga" class="p-3">${need.priceRange}</td>
                            <td data-label="Tgl Posting" class="p-3">${new Date(need.postDate).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' })}</td>
                            <td data-label="Status" class="p-3"><span class="text-xs font-medium px-2.5 py-0.5 rounded-full ${statusClass}">${need.status}</span></td>
                            <td data-label="Aksi" class="p-3 actions-cell">
                                <button class="delete-item-btn p-2 bg-slate-100 rounded-md hover:bg-rose-100" title="Hapus Kebutuhan">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-rose-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                                </button>
                            </td>
                        </tr>
                    `;
                    tableBody.insertAdjacentHTML('beforeend', row);
                });
            }

            let plantingCalendar, harvestingCalendar;
            function renderPlantingCalendar() {
                const calendarEl = document.getElementById('planting-calendar');
                if (!calendarEl || !window.FullCalendar) return;
                const schedules = getFromDB(DB_SCHEDULES_KEY).filter(s => s.type === 'tanam');
                if (plantingCalendar) {
                    plantingCalendar.destroy();
                }
                plantingCalendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' },
                    events: schedules,
                    locale: 'id'
                });
                plantingCalendar.render();
            }

            function renderHarvestingCalendar() {
                const calendarEl = document.getElementById('harvesting-calendar');
                if (!calendarEl || !window.FullCalendar) return;
                const schedules = getFromDB(DB_SCHEDULES_KEY).filter(s => s.type === 'panen');
                if (harvestingCalendar) {
                    harvestingCalendar.destroy();
                }
                harvestingCalendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' },
                    events: schedules,
                    locale: 'id'
                });
                harvestingCalendar.render();
            }

            function renderLandAreaTable() {
                const allLandAreas = getFromDB(DB_LAND_AREAS_KEY);
                const tableBody = document.getElementById('land-area-table-body');
                if (!tableBody) return;
                tableBody.innerHTML = '';
                // Asumsi data lahan adalah global dan bisa dilihat semua admin koperasi
                const landAreas = allLandAreas;

                if (landAreas.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center p-4">Belum ada data luas lahan dari petani.</td></tr>';
                    return;
                }
                landAreas.forEach(land => {
                    const statusClass = land.status === 'Aktif' ? 'bg-emerald-100 text-emerald-800' : 'bg-slate-100 text-slate-800';
                    const row = `
                        <tr data-id="${land.id}">
                            <td data-label="Petani/Kelompok" class="p-3 font-medium">${land.farmerName}</td>
                            <td data-label="Lokasi" class="p-3">${land.landLocation}</td>
                            <td data-label="Luas" class="p-3 text-right">${land.area} ${land.unit}</td>
                            <td data-label="Komoditas Utama" class="p-3">${land.commodity}</td>
                            <td data-label="Status" class="p-3">
                                <span class="text-xs font-medium px-2.5 py-0.5 rounded-full ${statusClass}">${land.status}</span>
                            </td>
                        </tr>
                    `;
                    tableBody.insertAdjacentHTML('beforeend', row);
                });
            }

            function renderLoansTable() {
                const allLoans = getFromDB(DB_LOANS_KEY);
                const allCustomers = getFromDB(DB_CUSTOMERS_KEY);
                const tableBody = document.getElementById('loans-table-body');
                if (!tableBody) return;
                tableBody.innerHTML = '';

                const koperasiCustomerIds = new Set(allCustomers.filter(c => c.koperasiAsal === window.loggedInKoperasi).map(c => c.id));
                const loans = allLoans.filter(l => koperasiCustomerIds.has(l.customerId));

                // Update summary cards
                document.getElementById('loan-total-amount').textContent = formatRupiah(loans.reduce((sum, l) => sum + l.amount, 0));
                document.getElementById('loan-active-count').textContent = loans.filter(l => l.status === 'Aktif').length;
                document.getElementById('loan-completed-count').textContent = loans.filter(l => l.status === 'Lunas').length;

                if (loans.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" class="text-center p-4">Belum ada data pinjaman.</td></tr>';
                    return;
                }

                loans.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(loan => {
                    const paidInstallments = loan.paymentHistory.length;
                    const remainingAmount = (loan.term - paidInstallments) * loan.installment;
                    const progress = (paidInstallments / loan.term) * 100;
                    const statusClasses = {
                        'Aktif': 'bg-blue-100 text-blue-800',
                        'Lunas': 'bg-emerald-100 text-emerald-800',
                        'Diajukan': 'bg-yellow-100 text-yellow-800',
                        'Ditolak': 'bg-rose-100 text-rose-800'
                    };
                    const statusClass = statusClasses[loan.status] || 'bg-slate-100 text-slate-800';

                    const row = `
                        <tr data-id="${loan.id}" class="cursor-pointer hover:bg-slate-50">
                            <td data-label="Anggota" class="p-3">
                                <p class="font-medium">${loan.customerName}</p>
                                <p class="text-xs text-slate-500 font-mono">${loan.id}</p>
                            </td>
                            <td data-label="Jumlah Pinjaman" class="p-3 text-right">${formatRupiah(loan.amount)}</td>
                            <td data-label="Angsuran" class="p-3 text-right">${formatRupiah(loan.installment)} /bln</td>
                            <td data-label="Sisa Tagihan" class="p-3 text-right font-semibold">${formatRupiah(remainingAmount)}</td>
                            <td data-label="Progres" class="p-3">
                                <div class="w-full bg-slate-200 rounded-full h-2.5">
                                    <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${progress}%"></div>
                                </div>
                                <p class="text-xs text-center mt-1">${paidInstallments}/${loan.term} bln</p>
                            </td>
                            <td data-label="Status" class="p-3 text-center">
                                <span class="text-xs font-medium px-2.5 py-0.5 rounded-full ${statusClass}">${loan.status}</span>
                            </td>
                            <td data-label="Aksi" class="p-3 actions-cell">
                                <div class="flex items-center justify-end space-x-2">
                                    ${loan.status === 'Aktif' ? `<button class="pay-installment-btn p-2 bg-emerald-100 rounded-md hover:bg-emerald-200" title="Bayar Angsuran"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-emerald-600" viewBox="0 0 20 20" fill="currentColor"><path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z" /><path fill-rule="evenodd" d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm3 0a1 1 0 011-1h1a1 1 0 110 2H8a1 1 0 01-1-1z" clip-rule="evenodd" /></svg></button>` : ''}
                                    ${loan.status === 'Diajukan' ? `<button class="approve-loan-btn p-2 bg-blue-100 rounded-md hover:bg-blue-200" title="Setujui Pinjaman"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg></button>` : ''}
                                    <button class="delete-item-btn p-2 bg-slate-100 rounded-md hover:bg-rose-100" title="Hapus"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-rose-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>
                                </div>
                            </td>
                        </tr>
                    `;
                    tableBody.insertAdjacentHTML('beforeend', row);
                });
            }

            function renderPurchasesTable() {
                const allPurchases = getFromDB(DB_PURCHASES_KEY);
                const tableBody = document.getElementById('purchases-table')?.querySelector('tbody');
                if (!tableBody) return;
                tableBody.innerHTML = '';
                
                const searchTerm = document.getElementById('purchase-search')?.value.toLowerCase() || '';
                const startDateVal = document.getElementById('purchase-start-date')?.value;
                const endDateVal = document.getElementById('purchase-end-date')?.value;
                
                const purchases = allPurchases.filter(p => p.koperasiAsal === window.loggedInKoperasi);

                const filteredPurchases = purchases.filter(p => {
                    const matchSearch = searchTerm === '' || 
                                        p.supplier.toLowerCase().includes(searchTerm) || 
                                        p.productName.toLowerCase().includes(searchTerm);
                    
                    const purchaseDate = new Date(p.date.split('T')[0]); // Normalisasi tanggal untuk perbandingan
                    const matchDate = (!startDateVal || purchaseDate >= new Date(startDateVal)) && 
                                      (!endDateVal || purchaseDate <= new Date(endDateVal));

                    return matchSearch && matchDate;
                });

                if (filteredPurchases.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-4">Belum ada riwayat pembelian.</td></tr>';
                    return;
                }

                filteredPurchases.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(p => {
                    const row = `
                        <tr data-id="${p.id}">
                            <td data-label="Tanggal" class="p-3">${new Date(p.date).toLocaleDateString('id-ID')}</td>
                            <td data-label="Pemasok" class="p-3 font-medium">${p.supplier}</td>
                            <td data-label="Produk" class="p-3">${p.productName}</td>
                            <td data-label="Jumlah" class="p-3 text-right">${p.quantity.toLocaleString('id-ID')} ${p.unit}</td>
                            <td data-label="Harga Beli" class="p-3 text-right">${formatRupiah(p.price)}</td>
                            <td data-label="Total" class="p-3 text-right font-semibold">${formatRupiah(p.total)}</td>
                        </tr>`;
                    tableBody.insertAdjacentHTML('beforeend', row);
                });
            }
            function updateSavingsMemberDropdown() {
                const customers = getFromDB(DB_CUSTOMERS_KEY);
                const koperasiCustomers = customers.filter(c => c.koperasiAsal === window.loggedInKoperasi);
                const select = document.getElementById('savings-member-select');
                select.innerHTML = '<option value="">-- Pilih Anggota --</option>';
                koperasiCustomers.forEach(c => {
                    select.insertAdjacentHTML('beforeend', `<option value="${c.id}">${c.name}</option>`);
                });
            }

            function renderSavingsTable() {
                const allCustomers = getFromDB(DB_CUSTOMERS_KEY);
                const customers = allCustomers.filter(c => c.koperasiAsal === window.loggedInKoperasi);
                if (!document.getElementById('savings-table')) return;
                const tableBody = document.getElementById('savings-table').querySelector('tbody');
                tableBody.innerHTML = '';
                if (customers.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-4">Belum ada data anggota.</td></tr>';
                    return;
                }
                customers.forEach(customer => {
                    const totalSimpanan = (customer.savings?.pokok || 0) + (customer.savings?.wajib || 0) + (customer.savings?.sukarela || 0);
                    const row = `
                        <tr data-id="${customer.id}">
                            <td data-label="Anggota" class="p-3 font-medium">${customer.name}</td>
                            <td data-label="Simpanan Pokok" class="p-3 text-right">${formatRupiah(customer.savings?.pokok || 0)}</td>
                            <td data-label="Simpanan Wajib" class="p-3 text-right">${formatRupiah(customer.savings?.wajib || 0)}</td>
                            <td data-label="Simpanan Sukarela" class="p-3 text-right">${formatRupiah(customer.savings?.sukarela || 0)}</td>
                            <td data-label="Total Simpanan" class="p-3 text-right font-semibold">${formatRupiah(totalSimpanan)}</td>
                            <td data-label="Aksi" class="p-3 actions-cell">
                                <button class="text-blue-600 hover:text-blue-900">Detail</button>
                            </td>
                        </tr>
                    `;
                    tableBody.insertAdjacentHTML('beforeend', row);
                });
            }
        
            // --- FUNGSI BARU UNTUK GRAFIK DASBOR (DIPERBAIKI) ---
            function createSalesChart(canvasId, orders, purchases) {
                // --- PERBAIKAN: Jika data tidak diberikan, ambil dari DB ---
                if (!orders) {
                    orders = getFromDB(DB_ORDERS_KEY);
                }
                if (!purchases) {
                    purchases = getFromDB(DB_PURCHASES_KEY);
                }
                // --- AKHIR PERBAIKAN ---

                const ctx = document.getElementById(canvasId)?.getContext('2d');
                if (!ctx) return;

                if (window.salesChartInstance) window.salesChartInstance.destroy();

                const now = new Date();
                const labels = Array.from({ length: 4 }).map((_, i) => {
                    const d = new Date(now.getFullYear(), now.getMonth() - (3 - i), 1);
                    return d.toLocaleString('id-ID', { month: 'short', year: 'numeric' });
                });

                const salesData = labels.map((label, i) => {
                    const month = now.getMonth() - (3 - i);
                    const year = now.getFullYear();
                    return orders
                        .filter(o => new Date(o.date).getMonth() === month && new Date(o.date).getFullYear() === year && o.status === 'Selesai')
                        .reduce((sum, o) => sum + o.totalPrice, 0);
                });

                const purchaseData = labels.map((label, i) => {
                    const month = now.getMonth() - (3 - i);
                    const year = now.getFullYear();
                    return purchases
                        .filter(p => new Date(p.date).getMonth() === month && new Date(p.date).getFullYear() === year)
                        .reduce((sum, p) => sum + p.total, 0);
                });

                window.salesChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: { labels: labels, datasets: [ { label: 'Total Penjualan', data: salesData, backgroundColor: 'rgba(16, 185, 129, 0.6)', borderColor: 'rgba(16, 185, 129, 1)', borderWidth: 1 }, { label: 'Total Pembelian', data: purchaseData, backgroundColor: 'rgba(59, 130, 246, 0.6)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 1 } ] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { callback: value => formatRupiah(value) } } } }
                });
            }

            function renderDashboardMetrics() {
                const allProducts = getFromDB(DB_PRODUCTS_KEY);
                const allOrders = getFromDB(DB_ORDERS_KEY); // Tetap ambil semua untuk disaring
                const allCustomers = getFromDB(DB_CUSTOMERS_KEY);
                const allPurchases = getFromDB(DB_PURCHASES_KEY);
                if (!document.getElementById('dashboard-total-revenue')) return;

                // --- PERBAIKAN: Saring semua data berdasarkan koperasi yang login ---
                const products = allProducts.filter(p => p.koperasiAsal === window.loggedInKoperasi); // Hanya produk koperasi ini
                const productNames = new Set(products.map(p => p.name));
                const orders = allOrders.filter(o => o.items.some(item => productNames.has(item.name)));
                const customerIdsInOrders = new Set(orders.map(o => o.customerId));
                const customers = allCustomers.filter(c => customerIdsInOrders.has(c.id)); // Hanya pelanggan yang pernah bertransaksi dengan koperasi ini
                const purchases = allPurchases.filter(p => p.koperasiAsal === window.loggedInKoperasi); // Hanya pembelian oleh koperasi ini
        
                // Total Revenue (FIXED)
                const totalRevenue = orders.reduce((sum, order) => {
                    if (order.status !== 'Selesai') return sum;
                    const revenueFromThisOrder = order.items.reduce((itemSum, item) => {
                        if (productNames.has(item.name)) { // Only add price of items belonging to this coop
                            return itemSum + (item.price * item.quantity);
                        }
                        return itemSum;
                    }, 0);
                    return sum + revenueFromThisOrder;
                }, 0);
                document.getElementById('dashboard-total-revenue').textContent = formatRupiah(totalRevenue);
        
                // New Orders
                const newOrders = orders.filter(order => ['Menunggu Verifikasi', 'Menunggu Pembayaran', 'Menunggu Pembayaran Tunai'].includes(order.status)).length; // Logic is correct for a count
                document.getElementById('dashboard-new-orders').textContent = newOrders;
        
                // Total Products
                document.getElementById('dashboard-total-products').textContent = products.length;
        
                // Total Customers
                document.getElementById('dashboard-total-customers').textContent = customers.length; 
        
            // === PENAMBAHAN LOGIKA UNTUK KARTU BARU ===
        
            // KPI: Total Stok Gudang (dalam Ton)
            const totalStockInTon = products.reduce((sum, p) => {
                const unit = p.unit.toLowerCase();
                if (unit === 'kg') return sum + (p.stock / 1000);
                if (unit === 'ton') return sum + p.stock;
                return sum; // Abaikan unit lain untuk total tonase
            }, 0);
            document.getElementById('kpi-total-stok').textContent = `${totalStockInTon.toFixed(2)} Ton`;
        
            // KPI: Terjual Hari Ini (FIXED)
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const salesToday = orders
                .filter(o => new Date(o.date) >= today)
                .reduce((sum, order) => {
                    const revenueFromThisOrder = order.items.reduce((itemSum, item) => {
                        if (productNames.has(item.name)) { // Only add price of items belonging to this coop
                            return itemSum + (item.price * item.quantity);
                        }
                        return itemSum;
                    }, 0);
                    return sum + revenueFromThisOrder;
                }, 0);
            document.getElementById('kpi-terjual-hari-ini').textContent = formatRupiah(salesToday);
        
            // KPI: Harga Rata-rata Beli
            const calculateAvgPrice = (sourceType) => {
                const relevantPurchases = purchases.filter(p => {
                    const supplier = p.supplier.toLowerCase();
                    if (sourceType === 'petani') return !supplier.includes('bumdes');
                    if (sourceType === 'bumdes') return supplier.includes('bumdes');
                    return false;
                });
                if (relevantPurchases.length === 0) return 0;
                const totalValue = relevantPurchases.reduce((sum, p) => sum + p.total, 0);
                const totalWeightKg = relevantPurchases.reduce((sum, p) => sum + (p.unit.toLowerCase() === 'ton' ? p.quantity * 1000 : p.quantity), 0);
                return totalWeightKg > 0 ? totalValue / totalWeightKg : 0;
            };
            document.getElementById('kpi-harga-petani').textContent = formatRupiah(calculateAvgPrice('petani'));
            document.getElementById('kpi-harga-bumdes').textContent = formatRupiah(calculateAvgPrice('bumdes'));

                // --- PERBAIKAN: Panggil fungsi grafik dengan data yang sudah disaring ---
                createSalesChart('salesChart', orders, purchases); // Panggil dengan data yang sudah difilter
                renderProductPieChart(products); // Panggil dengan data yang sudah difilter

                // Category Summary Cards
                const categoryGrid = document.getElementById('dashboard-category-summary-grid'); // Pastikan elemen ini ada
                categoryGrid.innerHTML = '';
                const categories = getFromDB(DB_CATEGORIES_KEY);
                if (categoryGrid && categories.length > 0) {
                    categories.forEach(category => {
                        const productsInCategory = products.filter(p => p.category === category);
                        const productCount = productsInCategory.length;
                        const totalStockValue = productsInCategory.reduce((sum, p) => sum + (p.stock * p.price), 0);
                        const hasLowStock = productsInCategory.some(p => p.stock > 0 && p.stock < p.threshold);

                        let statusIndicator = '';
                        if (hasLowStock) {
                            statusIndicator = `
                                <div class="absolute top-2 right-2 p-1.5 bg-yellow-100 rounded-full" title="Beberapa stok menipis">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-yellow-600" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                    </svg>
                                </div>`;
                        }

                        const cardHTML = `
                            <div class="border border-slate-200 bg-slate-50 rounded-lg p-4 relative transition hover:shadow-md hover:border-blue-300">
                                ${statusIndicator}
                                <h4 class="font-bold text-slate-800 text-lg truncate">${category}</h4>
                                <p class="text-sm text-slate-500">${productCount} Jenis Produk</p>
                                <div class="mt-4 pt-4 border-t">
                                    <p class="text-xs text-slate-500">Total Nilai Stok</p>
                                    <p class="text-xl font-semibold text-slate-700">${formatRupiah(totalStockValue)}</p>
                                </div>
                            </div>
                        `;
                        categoryGrid.insertAdjacentHTML('beforeend', cardHTML);
                    });
                }

            }

            function renderProductPieChart(productsForChart) { // PERBAIKAN: Terima data sebagai argumen
                const ctx = document.getElementById('productPieChart')?.getContext('2d');
                if (!ctx) return;
                if (window.productPieChartInstance) window.productPieChartInstance.destroy();

                const categoryData = productsForChart.reduce((acc, p) => {
                    const category = p.category || 'Lainnya';
                    const stockValue = p.stock * p.price;
                    acc[category] = (acc[category] || 0) + stockValue;
                    return acc;
                }, {});

                const labels = Object.keys(categoryData);
                const dataValues = Object.values(categoryData);

                window.productPieChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Nilai Stok',
                            data: dataValues,
                            backgroundColor: ['rgba(59, 130, 246, 0.7)', 'rgba(16, 185, 129, 0.7)', 'rgba(245, 158, 11, 0.7)', 'rgba(239, 68, 68, 0.7)', 'rgba(139, 92, 246, 0.7)', 'rgba(20, 184, 166, 0.7)', 'rgba(217, 70, 239, 0.7)'],
                            borderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { padding: 15 } }, tooltip: { callbacks: { label: (context) => `${context.label}: ${formatRupiah(context.raw)}` } } } }
                });
            }

            function populateCategoryFilter() {
                const categories = getFromDB(DB_CATEGORIES_KEY);
                const categoryFilter = document.getElementById('category-filter');
                const productCategory = document.getElementById('product-category');
                
                categoryFilter.innerHTML = '<option value="">Semua Kategori</option>';
                productCategory.innerHTML = '';

                categories.forEach(cat => {
                    categoryFilter.insertAdjacentHTML('beforeend', `<option value="${cat}">${cat}</option>`);
                    productCategory.insertAdjacentHTML('beforeend', `<option value="${cat}">${cat}</option>`);
                });
            }

            function renderProductsTable() {
                const products = getFromDB(DB_PRODUCTS_KEY);
                if (!document.getElementById('products-table')) return;
                const tableBody = document.getElementById('products-table').querySelector('tbody');
                tableBody.innerHTML = '';

                const searchTerm = document.getElementById('product-search').value.toLowerCase();
                const categoryFilter = document.getElementById('category-filter').value;

                // 1. Ambil semua produk milik koperasi yang sedang login
                const myKoperasiProducts = products.filter(p => p.koperasiAsal === window.loggedInKoperasi);

                // 2. Terapkan filter pencarian dan kategori pada produk milik koperasi
                const filteredProducts = myKoperasiProducts.filter(p => {
                    const matchesSearch = p.name.toLowerCase().includes(searchTerm);
                    const matchesCategory = categoryFilter ? p.category === categoryFilter : true;
                    return matchesSearch && matchesCategory;
                });

                // 3. Tentukan pesan yang akan ditampilkan jika tabel kosong
                if (filteredProducts.length === 0) {
                    // Jika ada filter aktif tapi hasilnya 0, tampilkan pesan "tidak ditemukan"
                    if (searchTerm || categoryFilter) {
                        tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-4">Produk tidak ditemukan untuk filter ini.</td></tr>';
                    } else {
                        // Jika tidak ada filter dan produk memang 0, tampilkan pesan untuk menambah produk
                        tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-4">Belum ada produk. Silakan klik "Tambah Produk" untuk memulai.</td></tr>';
                    }
                    return;
                }

                filteredProducts.forEach(product => {
                    let stockStatus;
                    if (product.stock <= 0) {
                        stockStatus = '<span class="bg-rose-100 text-rose-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Habis</span>';
                    } else if (product.stock < product.threshold) {
                        stockStatus = '<span class="bg-yellow-100 text-yellow-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Menipis</span>';
                    } else {
                        stockStatus = '<span class="bg-emerald-100 text-emerald-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Aman</span>';
                    }

                    const row = `
                        <tr data-id="${product.id}">
                            <td data-label="Produk" class="p-3">
                                <div class="flex items-center">
                                    <img src="${product.image}" alt="${product.name}" class="w-10 h-10 rounded-md mr-3 object-cover">
                                    <div>
                                        <p class="font-medium">${product.name}</p>
                                        <p class="text-sm text-slate-500">${(product.description || '').substring(0, 30)}...</p>
                                    </div>
                                </div>
                            </td>
                            <td data-label="Kategori" class="p-3">${product.category}</td>
                            <td data-label="Harga" class="p-3">${formatRupiah(product.price)}</td>
                            <td data-label="Stok" class="p-3">${product.stock} ${product.unit}</td>
                            <td data-label="Status" class="p-3">${stockStatus}</td>
                            <td data-label="Aksi" class="p-3 actions-cell space-x-2">
                                <button class="edit-product-btn p-2 bg-slate-100 rounded-md hover:bg-slate-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-600" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                                <button class="delete-item-btn p-2 bg-slate-100 rounded-md hover:bg-rose-100"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-rose-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>
                            </td>
                        </tr>
                    `;
                    tableBody.insertAdjacentHTML('beforeend', row);
                });
            }
            
            function createProductRow(product) {
                let stockStatus = '<span class="bg-emerald-100 text-emerald-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Aman</span>';
                if (product.stock <= 0) stockStatus = '<span class="bg-rose-100 text-rose-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Habis</span>';
                else if (product.stock < product.threshold) stockStatus = '<span class="bg-yellow-100 text-yellow-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Menipis</span>';
                return `<tr data-id="${product.id}"><td data-label="Produk" class="p-3"><div class="flex items-center"><img src="${product.image}" alt="${product.name}" class="w-10 h-10 rounded-md mr-3 object-cover"><div><p class="font-medium">${product.name}</p><p class="text-sm text-slate-500">${(product.description || '').substring(0, 30)}...</p></div></div></td><td data-label="Kategori" class="p-3">${product.category}</td><td data-label="Harga" class="p-3">${formatRupiah(product.price)}</td><td data-label="Stok" class="p-3">${product.stock} ${product.unit}</td><td data-label="Status" class="p-3">${stockStatus}</td><td data-label="Aksi" class="p-3 actions-cell space-x-2"><button class="edit-product-btn p-2 bg-slate-100 rounded-md hover:bg-slate-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-600" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button><button class="delete-item-btn p-2 bg-slate-100 rounded-md hover:bg-rose-100"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-rose-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button></td></tr>`;
            }

            function updateSidebarBadges() {
                // --- PERBAIKAN LOGIKA: Ambil dan saring data yang relevan di sini ---
                const allOrders = getFromDB(DB_ORDERS_KEY);
                const allProducts = getFromDB(DB_PRODUCTS_KEY);
                const koperasiProductNames = new Set(allProducts.filter(p => p.koperasiAsal === window.loggedInKoperasi).map(p => p.name));
                const koperasiOrders = allOrders.filter(o => o.items.some(item => koperasiProductNames.has(item.name)));
                // --- AKHIR PERBAIKAN ---

                // Badge untuk Pesanan Baru
                const newOrders = koperasiOrders.filter(o => ['Menunggu Verifikasi', 'Menunggu Pembayaran', 'Menunggu Pembayaran Tunai'].includes(o.status)).length;
                const badgePesanan = document.getElementById('badge-pesanan');
                if (newOrders > 0) {
                    badgePesanan.textContent = newOrders;
                    badgePesanan.classList.remove('hidden');
                } else {
                    badgePesanan.classList.add('hidden');
                }

                // Badge untuk Ulasan (juga difilter berdasarkan pesanan koperasi ini)
                // Variabel koperasiOrders sekarang sudah didefinisikan dengan benar
                const pendingReviews = koperasiOrders.filter(o => o.status === 'Selesai' && o.rating === 0).length;
                const badgeUlasan = document.getElementById('badge-ulasan');
                if (pendingReviews > 0) {
                    badgeUlasan.textContent = pendingReviews;
                    badgeUlasan.classList.remove('hidden');
                } else {
                    badgeUlasan.classList.add('hidden');
                }

                // Badge untuk Penawaran Petani
                const newOffers = getFromDB(DB_FARMER_OFFERS_KEY).filter(o => o.status === 'Tersedia').length;
                const badgePenawaran = document.getElementById('badge-penawaran');
                if (newOffers > 0) { badgePenawaran.textContent = newOffers; badgePenawaran.classList.remove('hidden'); } else { badgePenawaran.classList.add('hidden'); }

                // Badge untuk Pesan Permintaan (Baru)
                const newRequests = getFromDB(DB_REQUESTS_KEY).filter(r => r.status === 'Baru').length;
                const badgePermintaan = document.getElementById('badge-permintaan');
                if (newRequests > 0) {
                    badgePermintaan.textContent = newRequests;
                    badgePermintaan.classList.remove('hidden');
                } else {
                    badgePermintaan.classList.add('hidden');
                }
            }

        // --- CRUD & MODAL FUNCTIONS ---

        function openProductModal(productId = null) {
            const modal = document.getElementById('product-modal');
            const form = document.getElementById('product-form');
            // PERBAIKAN (v2): Reset form dan semua yang terkait gambar secara eksplisit
            form.reset();
            document.getElementById('product-id').value = '';
            document.getElementById('product-image-preview').innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
            `;
            document.getElementById('product-image-base64').value = '';

            if (productId) {
                // Panggil populateCategoryFilter() untuk memastikan dropdown kategori sinkron
                populateCategoryFilter();

                const products = getFromDB(DB_PRODUCTS_KEY);
                const product = products.find(p => p.id === productId);
                if (product) {
                    document.getElementById('product-modal-title').textContent = 'Edit Produk';
                    document.getElementById('product-id').value = product.id;
                    document.getElementById('product-name').value = product.name;
                    if (product.image) {
                        document.getElementById('product-image-preview').innerHTML = `<img src="${product.image}" class="w-full h-full object-cover rounded-lg">`;
                        document.getElementById('product-image-base64').value = product.image;
                    }
                    document.getElementById('product-category').value = product.category;
                    document.getElementById('product-price').value = product.price;
                    document.getElementById('product-stock').value = product.stock;
                    document.getElementById('product-unit').value = product.unit;
                    document.getElementById('product-threshold').value = product.threshold;
                    document.getElementById('product-description').value = product.description || '';
                }
            } else {
                // Panggil juga saat menambah produk baru
                populateCategoryFilter();
                document.getElementById('product-modal-title').textContent = 'Tambah Produk Baru';
            }
            openModal(modal);
        }

        function saveProduct() {
            // Loading state for save button
            let products = getFromDB(DB_PRODUCTS_KEY);
            const saveBtn = document.getElementById('save-product-btn');
            const productId = parseInt(document.getElementById('product-id').value);
            const productData = {
                name: document.getElementById('product-name').value,
                image: document.getElementById('product-image-base64').value || 'https://placehold.co/40x40/d1d5db/1f2937?text=N/A', // PERBAIKAN (v2): Logika pengambilan gambar sudah benar
                category: document.getElementById('product-category').value,
                price: parseInt(document.getElementById('product-price').value),
                stock: parseInt(document.getElementById('product-stock').value) || 0, // PERBAIKAN: Default ke 0 jika kosong
                unit: document.getElementById('product-unit').value,
                threshold: parseInt(document.getElementById('product-threshold').value),
                description: document.getElementById('product-description').value,
                lastUpdate: new Date().toISOString(), // Waktu data diperbarui
                koperasiAsal: window.loggedInKoperasi // Secara otomatis menetapkan produk ke koperasi yang sedang login
            };

            // Validasi sederhana
            if (!productData.name || !productData.price || !productData.stock) {
                showAlert('Nama, harga, dan stok produk tidak boleh kosong.', 'error');
                saveBtn.disabled = false; // Aktifkan kembali tombol jika gagal
                return;
            }

            if (productId) { // Edit
                const index = products.findIndex(p => p.id === productId);
                if (index > -1) {
                    products[index] = { ...products[index], ...productData };
                    showAlert('Produk berhasil diperbarui.');
                }
            } else { // Add new product
                productData.id = Date.now(); // Pastikan ID baru ditambahkan ke objek
                products.push(productData);
                showAlert('Produk baru berhasil ditambahkan.');
            }
            saveToDB(DB_PRODUCTS_KEY, products);
            renderProductsTable();
            // Langsung tutup modal tanpa jeda
            closeModal(document.getElementById('product-modal'));
        }

        function openCustomerModal(customerId = null) {
            const modal = document.getElementById('customer-modal');
            const form = document.getElementById('customer-form');
            form.reset();
            document.getElementById('customer-id').value = '';
            document.getElementById('customer-password-section').style.display = 'block';
            document.getElementById('customer-management-section').style.display = 'none';
            document.getElementById('customer-email').readOnly = false;

            if (customerId) {
                const customers = getFromDB(DB_CUSTOMERS_KEY);
                const customer = customers.find(c => c.id === customerId);
                if (customer) {
                    document.getElementById('customer-modal-title').textContent = 'Edit Anggota';
                    document.getElementById('customer-id').value = customer.id;
                    document.getElementById('customer-name').value = customer.name;
                    document.getElementById('customer-email').value = customer.email;
                    document.getElementById('customer-email').readOnly = true;
                    document.getElementById('customer-phone').value = customer.phone;
                    document.getElementById('customer-password-section').style.display = 'none';
                    document.getElementById('customer-management-section').style.display = 'block';
                }
            } else {
                document.getElementById('customer-modal-title').textContent = 'Tambah Anggota Baru';
            }
            openModal(modal);
        }

        function saveCustomer() {
            let customers = getFromDB(DB_CUSTOMERS_KEY);
            const customerId = parseInt(document.getElementById('customer-id').value);
            const email = document.getElementById('customer-email').value;

            if (customerId) { // Edit
                const index = customers.findIndex(c => c.id === customerId);
                if (index > -1) {
                    customers[index].name = document.getElementById('customer-name').value;
                    customers[index].phone = document.getElementById('customer-phone').value;
                    showAlert('Data anggota berhasil diperbarui.');
                }
            } else { // Add
                if (customers.some(c => c.email === email)) {
                    showAlert('Email sudah terdaftar.', 'error');
                    return;
                }
                // --- PERBAIKAN: Validasi dan ambil password ---
                const password = document.getElementById('customer-password').value;
                const confirmPassword = document.getElementById('customer-confirm-password').value;
                const passwordErrorMsg = document.getElementById('password-error-msg');
                passwordErrorMsg.classList.add('hidden');

                if (password.length < 6 || password !== confirmPassword) {
                    passwordErrorMsg.textContent = password.length < 6 ? 'Password minimal 6 karakter.' : 'Konfirmasi password tidak cocok.';
                    passwordErrorMsg.classList.remove('hidden');
                    return; // Hentikan proses jika password tidak valid
                }
                // --- AKHIR PERBAIKAN ---
                const newCustomer = {
                    id: Date.now(),
                    name: document.getElementById('customer-name').value,
                    email: email,
                    phone: document.getElementById('customer-phone').value,
                    joinDate: new Date().toISOString().split('T')[0],
                    status: 'Aktif',
                    savings: { pokok: 0, wajib: 0, sukarela: 0 },
                    password: password, // Simpan password ke data pengguna
                    koperasiAsal: window.loggedInKoperasi // PERBAIKAN: Tambahkan penanda koperasi
                };
                customers.push(newCustomer);
                showAlert('Anggota baru berhasil ditambahkan.');
            }
            saveToDB(DB_CUSTOMERS_KEY, customers);
            renderCustomersTable();
            closeModal(document.getElementById('customer-modal'));
        }

        function openCategoryModal(categoryName = null) {
            const modal = document.getElementById('category-modal');
            const form = modal.querySelector('form');
            form.reset();
            document.getElementById('original-category-name').value = '';

            if (categoryName) {
                // Logika edit dinonaktifkan karena kategori statis
                showAlert('Manajemen kategori dinonaktifkan.', 'error');
                return;
            } 
            openModal(modal);
        }

        function saveCategory() {
            const saveBtn = document.getElementById('save-category-btn');
            saveBtn.disabled = true; // Nonaktifkan tombol saat proses dimulai

            const categoryName = document.getElementById('category-name-input').value.trim();
            if (!categoryName) {
                showAlert('Nama kategori tidak boleh kosong.', 'error');
                saveBtn.disabled = false; // Aktifkan kembali jika validasi gagal
                return;
            }
            let categories = getFromDB(DB_CATEGORIES_KEY);
            if (categories.map(c => c.toLowerCase()).includes(categoryName.toLowerCase())) {
                showAlert('Kategori dengan nama tersebut sudah ada.', 'error');
                saveBtn.disabled = false; // Aktifkan kembali jika validasi gagal
                return;
            }
            categories.push(categoryName);
            saveToDB(DB_CATEGORIES_KEY, categories);
            showAlert('Kategori baru berhasil ditambahkan.');
            renderCategoriesTable();
            populateCategoryFilter(); // Perbarui juga dropdown di tempat lain

            // Tombol tidak perlu diaktifkan lagi karena modal akan ditutup
            // Langsung tutup modal
            closeModal(document.getElementById('category-modal'));
        }

        function openDeleteModal(message) {
            document.getElementById('delete-confirm-text').textContent = message;
            openModal(document.getElementById('delete-confirm-modal'));
        }

        function confirmDelete() {
                if (!itemToDelete || !itemToDelete.type || !itemToDelete.id) return;

            if (itemToDelete.type === 'review') {
                let orders = getFromDB(DB_ORDERS_KEY);
                const index = orders.findIndex(o => o.id === itemToDelete.id);
                if (index > -1) {
                    orders[index].rating = 0;
                    orders[index].comment = '';
                }
                saveToDB(DB_ORDERS_KEY, orders);
            } else {
                    const dbKeyMap = { 'product': DB_PRODUCTS_KEY, 'customer': DB_CUSTOMERS_KEY, 'category': DB_CATEGORIES_KEY, 'banner': DB_BANNERS_KEY, 'voucher': DB_VOUCHERS_KEY, 'stockNeed': DB_STOCK_NEEDS_KEY, 'farmerOffer': DB_FARMER_OFFERS_KEY, 'loan': DB_LOANS_KEY };
                const dbKey = dbKeyMap[itemToDelete.type];
                if (!dbKey) return;
                let data = getFromDB(dbKey);
                let filteredData = data.filter(item => (item.id || item) !== itemToDelete.id);
                saveToDB(dbKey, filteredData);
            }

            showAlert(`${itemToDelete.type.charAt(0).toUpperCase() + itemToDelete.type.slice(1)} "${itemToDelete.name}" berhasil dihapus.`);
            
            const renderFunction = {
                'product': renderProductsTable,
                'customer': renderCustomersTable,
                'category': () => { renderCategoriesTable(); populateCategoryFilter(); },
                'banner': renderBannerTable,
                'voucher': renderVouchersTable,
                'stockNeed': renderStockNeedsTable,
                'farmerOffer': renderFarmerOffersTable,
                'loan': renderLoansTable,
                'review': renderReviewsTable,
            }[itemToDelete.type];
            renderFunction?.();

            closeModal(document.getElementById('delete-confirm-modal'));
            itemToDelete = { element: null, type: null, id: null };
        }

        function openOrderDetailModal(orderId, orderType = 'regular') {
            let order;
            const isPerumda = orderType === 'perumda';

            if (isPerumda) {
                const perumdaOrders = getFromDB(DB_PERUMDA_ORDERS_KEY);
                order = perumdaOrders.find(o => o.id === orderId);
            } else {
                const regularOrders = getFromDB(DB_ORDERS_KEY);
                order = regularOrders.find(o => o.id === orderId);
            }

            if (!order) return;

            const modal = document.getElementById('order-detail-modal');
            const title = isPerumda ? `Detail Pesanan Perumda #${order.id}` : `Detail Pesanan #${order.id}`;
            const customerInfo = isPerumda 
                ? `<p><strong>Nama Perusahaan:</strong> ${order.customer}</p>`
                : `<p><strong>Nama:</strong> ${order.customerName}</p><p><strong>Alamat:</strong> ${order.deliveryAddress}</p>`;
            const summaryInfo = `<p><strong>Tanggal:</strong> ${new Date(order.date).toLocaleString('id-ID')}</p>${!isPerumda ? `<p><strong>Metode Bayar:</strong> ${order.paymentMethod}</p>` : ''}<p><strong>Total:</strong> <span class="font-bold">${formatRupiah(isPerumda ? order.total : order.totalPrice)}</span></p>`;
            
            modal.querySelector('#order-detail-title').textContent = title;
            modal.querySelector('#order-detail-customer-info').innerHTML = customerInfo;
            modal.querySelector('#order-detail-summary-info').innerHTML = summaryInfo;
            
            const itemsTable = document.getElementById('order-detail-items-table');
            itemsTable.innerHTML = '';
            order.items.forEach(item => {
                const price = item.price || 0;
                const quantity = item.quantity || 0;
                itemsTable.innerHTML += `<tr><td class="p-3">${item.name}</td><td class="p-3 text-center">${quantity} ${item.unit}</td><td class="p-3 text-right">${formatRupiah(price)}</td><td class="p-3 text-right">${formatRupiah(price * quantity)}</td></tr>`;
            });

            const ratingDisplay = document.getElementById('rating-display');
            if (!isPerumda && order.rating > 0) {
                document.getElementById('rating-stars').textContent = '⭐'.repeat(order.rating) + '☆'.repeat(5 - order.rating);
                document.getElementById('rating-comment').textContent = order.comment || '-';
                ratingDisplay.classList.remove('hidden');
            } else {
                ratingDisplay.classList.add('hidden');
            }

            const statusSelect = document.getElementById('update-status');
            if (isPerumda) {
                statusSelect.innerHTML = `<option>Menunggu Verifikasi</option><option>Diproses</option><option>Selesai</option>`;
                // Sembunyikan tombol simpan biasa, karena alur Perumda mungkin berbeda
                document.getElementById('save-order-status-btn').classList.add('hidden');
            } else {
                statusSelect.innerHTML = `<option>Menunggu Pembayaran</option><option>Menunggu Verifikasi</option><option>Menunggu Pembayaran Tunai</option><option>Diproses</option><option>Dikirim</option><option>Selesai</option><option>Dibatalkan</option>`;
            }
            statusSelect.value = order.status;

            // --- LOGIKA BARU: Tampilkan tombol yang sesuai ---
            const saveButton = document.getElementById('save-order-status-btn');
            saveButton.classList.remove('hidden'); // Tampilkan tombol secara default
            if (order.status === 'Menunggu Verifikasi') {
                saveButton.textContent = 'Verifikasi Pembayaran';
                saveButton.onclick = () => verifyPayment(order.id); // PERBAIKAN: Bungkus dalam arrow function
            } else {
                saveButton.textContent = 'Simpan Perubahan';
                saveButton.onclick = () => saveOrderStatus(order.id, orderType); // PERBAIKAN: Bungkus dalam arrow function
            }

            openModal(modal);
        }

        function saveOrderStatus(orderId, orderType = 'regular') {
            const isPerumda = orderType === 'perumda';
            const dbKey = isPerumda ? DB_PERUMDA_ORDERS_KEY : DB_ORDERS_KEY;
            const renderFunc = isPerumda ? renderPerumdaOrdersTable : renderOrdersTable;

            let orders = getFromDB(dbKey);
            const index = orders.findIndex(o => o.id === orderId);

            if (index > -1) {
                orders[index].status = document.getElementById('update-status').value;
                saveToDB(dbKey, orders);
                showAlert(`Status pesanan ${isPerumda ? 'Perumda ' : ''}#${orderId} berhasil diperbarui.`);
                renderFunc();
                closeModal(document.getElementById('order-detail-modal'));
            }
        }

        function verifyPayment(orderId) {
            let orders = getFromDB(DB_ORDERS_KEY);
            const index = orders.findIndex(o => o.id === orderId);

            if (index > -1) {
                orders[index].status = 'Diproses'; // Ubah status menjadi "Diproses"
                saveToDB(DB_ORDERS_KEY, orders);
                showAlert(`Pembayaran untuk pesanan #${orderId} berhasil diverifikasi.`);
                renderOrdersTable();
                updateSidebarBadges();
                closeModal(document.getElementById('order-detail-modal'));
            }
        }

                    function saveVoucher() {
                        const code = document.getElementById('voucher-code-input').value.trim().toUpperCase();
                        const type = document.getElementById('voucher-type').value;
                        const value = parseInt(document.getElementById('voucher-value').value);
        
                        if (!code || !value) {
                            showAlert('Kode dan nilai voucher tidak boleh kosong.', 'error');
                            return;
                        }
        
                        let vouchers = getFromDB(DB_VOUCHERS_KEY);
                        const newVoucher = {
                            id: 'v' + Date.now(),
                            code: code,
                            type: type,
                            value: value
                        };
        
                        vouchers.push(newVoucher);
                        saveToDB(DB_VOUCHERS_KEY, vouchers);
                        showAlert('Voucher baru berhasil ditambahkan.');
                        renderVouchersTable();
                        closeModal(document.getElementById('add-voucher-modal'));
                    }
        
                    function handleBannerUpload(event) {            const files = event.target.files;
            if (files.length === 0) return;
            let banners = getFromDB(DB_BANNERS_KEY);

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const newBanner = {
                        id: Date.now() + Math.random(),
                        name: file.name,
                        image: e.target.result
                    };
                    banners.push(newBanner);
                    saveToDB(DB_BANNERS_KEY, banners);
                    renderBannerTable();
                };
                reader.readAsDataURL(file);
            });
            showAlert(`${files.length} banner berhasil diunggah.`);
        }

        function processSavingsTransaction() {
            const memberId = parseInt(document.getElementById('savings-member-select').value);
            const action = document.querySelector('input[name="savings-action"]:checked').value;
            const type = document.getElementById('savings-type').value;
            const amount = parseInt(document.getElementById('savings-amount').value);

            if (!memberId || !amount || amount <= 0) {
                showAlert('Harap lengkapi semua data dengan benar.', 'error');
                return;
            }

            let customers = getFromDB(DB_CUSTOMERS_KEY);
            const customerIndex = customers.findIndex(c => c.id === memberId);

            if (customerIndex > -1) {
                const customer = customers[customerIndex];
                if (action === 'deposit') {
                    customer.savings[type] += amount;
                    showAlert(`Setoran ${formatRupiah(amount)} untuk ${customer.name} berhasil.`);
                } else { // withdraw
                    if (customer.savings[type] >= amount) {
                        customer.savings[type] -= amount;
                        showAlert(`Penarikan ${formatRupiah(amount)} untuk ${customer.name} berhasil.`);
                    } else {
                        showAlert(`Saldo simpanan ${type} tidak mencukupi.`, 'error');
                        return;
                    }
                }
                saveToDB(DB_CUSTOMERS_KEY, customers);
                renderSavingsTable();
                closeModal(document.getElementById('savings-transaction-modal'));
            } else {
                showAlert('Anggota tidak ditemukan.', 'error');
            }
        }

        function openLoanModal(loanId = null) {
            const modal = document.getElementById('loan-modal');
            const form = document.getElementById('loan-form');
            form.reset();
            document.getElementById('loan-id').value = '';

            // Populate member dropdown
            const memberSelect = document.getElementById('loan-member-select');
            memberSelect.innerHTML = '<option value="">-- Pilih Anggota --</option>';
            getFromDB(DB_CUSTOMERS_KEY).forEach(c => {
                memberSelect.insertAdjacentHTML('beforeend', `<option value="${c.id}">${c.name}</option>`);
            });

            // For now, we only support adding new loans, not editing.
            document.getElementById('loan-modal-title').textContent = 'Pengajuan Pinjaman Baru';
            openModal(modal);
        }

        function saveLoan() {
            let loans = getFromDB(DB_LOANS_KEY);
            const customers = getFromDB(DB_CUSTOMERS_KEY);
            const customerId = parseInt(document.getElementById('loan-member-select').value);
            const customer = customers.find(c => c.id === customerId);

            const amount = parseInt(document.getElementById('loan-amount').value);
            const term = parseInt(document.getElementById('loan-term').value);
            const interestRate = parseFloat(document.getElementById('loan-interest').value);

            if (!customer || !amount || !term || !interestRate) {
                showAlert('Harap lengkapi semua data dengan benar.', 'error');
                return;
            }

            const totalInterest = amount * (interestRate / 100) * term;
            const totalPayment = amount + totalInterest;
            const installment = Math.ceil(totalPayment / term);

            const newLoan = {
                id: 'LN-' + Date.now(),
                customerId: customer.id,
                customerName: customer.name,
                amount: amount,
                interestRate: interestRate,
                term: term,
                installment: installment,
                status: 'Diajukan',
                date: new Date().toISOString().split('T')[0],
                paymentHistory: [] // FIX: Initialize paymentHistory array
            };

            loans.push(newLoan);
            saveToDB(DB_LOANS_KEY, loans);
            showAlert(`Pengajuan pinjaman untuk ${customer.name} berhasil dibuat.`);
            renderLoansTable();
            closeModal(document.getElementById('loan-modal'));
        }

        function handleLoanTableActions(e) {
            const approveBtn = e.target.closest('.approve-loan-btn');
            const payBtn = e.target.closest('.pay-installment-btn');
            const deleteBtn = e.target.closest('.delete-item-btn');
            const isActionClick = approveBtn || payBtn || deleteBtn;
            const row = e.target.closest('tr');
            if (!row) return;
            const loanId = row.dataset.id;
            let loans = getFromDB(DB_LOANS_KEY);
            const loanIndex = loans.findIndex(l => l.id === loanId);
            if (loanIndex === -1) return;

            if (approveBtn) {
                loans[loanIndex].status = 'Aktif';
                showAlert(`Pinjaman #${loanId} telah disetujui.`);
            } else if (payBtn) {
                loans[loanIndex].paymentHistory.push({
                    date: new Date().toISOString().split('T')[0],
                    amount: loans[loanIndex].installment
                });
                const paidCount = loans[loanIndex].paymentHistory.length;
                if (paidCount >= loans[loanIndex].term) {
                    loans[loanIndex].status = 'Lunas';
                    showAlert(`Pinjaman #${loanId} telah lunas.`);
                } else {
                    showAlert(`Angsuran ke-${paidCount} untuk pinjaman #${loanId} berhasil dibayar.`);
                }
            } else if (deleteBtn) {
                const loan = loans[loanIndex];
                itemToDelete = { type: 'loan', id: loanId, name: `pinjaman ${loan.customerName}` };
                openDeleteModal(`Anda yakin ingin menghapus ${itemToDelete.name}?`);
                return; // Prevent saving DB immediately
            }
            // If it's not an action button click, open the detail modal
            else if (!isActionClick) {
                openLoanDetailModal(loanId);
                return; // Prevent re-rendering table unnecessarily
            }

            saveToDB(DB_LOANS_KEY, loans);
            renderLoansTable();
        }

        function openLoanDetailModal(loanId) {
            const loans = getFromDB(DB_LOANS_KEY);
            const loan = loans.find(l => l.id === loanId);
            if (!loan) return;

            document.getElementById('loan-detail-title').textContent = `Detail Pinjaman #${loan.id}`;
            const contentDiv = document.getElementById('loan-detail-content');
            
            const paidInstallments = loan.paymentHistory.length;
            const remainingAmount = (loan.term - paidInstallments) * loan.installment;

            let historyRows = '';
            if (loan.paymentHistory.length > 0) {
                loan.paymentHistory.forEach((p, index) => {
                    historyRows += `<tr><td class="p-3">${index + 1}</td><td class="p-3">${new Date(p.date).toLocaleDateString('id-ID')}</td><td class="p-3 text-right">${formatRupiah(p.amount)}</td></tr>`;
                });
            } else {
                historyRows = '<tr><td colspan="3" class="p-3 text-center text-slate-500">Belum ada riwayat pembayaran.</td></tr>';
            }

            contentDiv.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><h4 class="font-semibold mb-2">Informasi Peminjam</h4><div class="text-sm space-y-1"><p><strong>Nama:</strong> ${loan.customerName}</p><p><strong>ID Anggota:</strong> ${loan.customerId}</p></div></div>
                    <div><h4 class="font-semibold mb-2">Ringkasan Pinjaman</h4><div class="text-sm space-y-1"><p><strong>Tanggal Pengajuan:</strong> ${new Date(loan.date).toLocaleDateString('id-ID')}</p><p><strong>Jumlah Pokok:</strong> ${formatRupiah(loan.amount)}</p><p><strong>Tenor:</strong> ${loan.term} bulan</p><p><strong>Bunga:</strong> ${loan.interestRate}% / bulan</p></div></div>
                </div>
                <div><h4 class="font-semibold mb-2">Status Pembayaran</h4><div class="text-sm space-y-1"><p><strong>Angsuran per Bulan:</strong> ${formatRupiah(loan.installment)}</p><p><strong>Angsuran Terbayar:</strong> ${paidInstallments} dari ${loan.term}</p><p><strong>Sisa Tagihan:</strong> <span class="font-bold text-rose-600">${formatRupiah(remainingAmount)}</span></p></div></div>
                <div><h4 class="font-semibold mb-2">Riwayat Pembayaran Angsuran</h4>
                    <div class="overflow-x-auto border rounded-lg max-h-60">
                        <table class="w-full text-left text-sm"><thead class="bg-slate-50 sticky top-0"><tr><th class="p-3">Angsuran Ke-</th><th class="p-3">Tanggal Bayar</th><th class="p-3 text-right">Jumlah</th></tr></thead><tbody class="divide-y">${historyRows}</tbody></table>
                    </div>
                </div>
            `;

            openModal(document.getElementById('loan-detail-modal'));
        }

        function savePurchase() {
            const saveBtn = document.getElementById('save-purchase-btn');
            saveBtn.disabled = true;
            saveBtn.querySelector('.btn-text').classList.add('hidden');
            saveBtn.querySelector('.btn-spinner').classList.remove('hidden');

            const newPurchase = {
                id: 'PUR-' + Date.now(),
                date: document.getElementById('purchase-date').value,
                supplier: document.getElementById('purchase-supplier').value,
                productName: document.getElementById('purchase-product-name').value,
                quantity: parseFloat(document.getElementById('purchase-quantity').value),
                unit: document.getElementById('purchase-unit').value,
                price: parseFloat(document.getElementById('purchase-price').value), // Harga beli per unit
                koperasiAsal: window.loggedInKoperasi // <-- PERBAIKAN: Ambil dari sesi login global
            };
            newPurchase.total = newPurchase.quantity * newPurchase.price;

            let purchases = getFromDB(DB_PURCHASES_KEY);
            purchases.push(newPurchase);
            saveToDB(DB_PURCHASES_KEY, purchases);
            
            showAlert('Data pembelian berhasil dicatat.');
            renderPurchasesTable();
            saveBtn.disabled = false;
            saveBtn.querySelector('.btn-text').classList.remove('hidden');
            saveBtn.querySelector('.btn-spinner').classList.add('hidden');
            closeModal(document.getElementById('purchase-modal'));
        }

            function handleChangePassword(e) {
                e.preventDefault();
                const passwordErrorMsg = document.getElementById('password-error-msg');
                passwordErrorMsg.classList.add('hidden');

                const oldPassword = document.getElementById('old-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-new-password').value;

                let externalUsers = getFromDB(DB_EXTERNAL_USERS_KEY);
                const currentUserIndex = externalUsers.findIndex(u => u.entity === window.loggedInKoperasi);
                if (currentUserIndex === -1) return;

                const currentUser = externalUsers[currentUserIndex];

                if (oldPassword !== currentUser.password) {
                    passwordErrorMsg.textContent = 'Password lama salah.';
                    passwordErrorMsg.classList.remove('hidden');
                } else if (newPassword.length < 6) {
                    passwordErrorMsg.textContent = 'Password baru minimal 6 karakter.';
                    passwordErrorMsg.classList.remove('hidden');
                } else if (newPassword !== confirmPassword) {
                    passwordErrorMsg.textContent = 'Konfirmasi password baru tidak cocok.';
                    passwordErrorMsg.classList.remove('hidden');
                } else {
                    externalUsers[currentUserIndex].password = newPassword;
                    saveToDB(DB_EXTERNAL_USERS_KEY, externalUsers);
                    showAlert('Password berhasil diubah!');
                    closeModal(document.getElementById('change-password-modal'));
                }
            }
            // --- INITIALIZATION ---
            initializeDatabase();
            populateCategoryFilter();

            // --- DYNAMIC UI UPDATE ---
            document.getElementById('sidebar-koperasi-name').textContent = window.loggedInKoperasi;
            document.getElementById('sidebar-admin-name').textContent = `oleh ${window.loggedInAdminName}`;
            const adminInitial = window.loggedInAdminName.charAt(0).toUpperCase();
            document.getElementById('profile-avatar').src = `https://placehold.co/40x40/E2E8F0/475569?text=${adminInitial}`;
            document.getElementById('profile-avatar').alt = loggedInAdminName;

            // Panggil update badge setelah inisialisasi
            showPage(window.location.hash.substring(1) || 'page-dasbor');
        });
    </script>
</body>
</html>
